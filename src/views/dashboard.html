<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMDA | Terminal de Control de Distribuci√≥n</title>

    <!-- Scripts de Sistema e Integraci√≥n -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- VIG√çA: Debugger de Conexi√≥n -->
    <script src="debug_connection.js"></script>
    <script src="debug_viewer.js"></script> <!-- DEBUG VISOR -->
    <!-- SheetJS (Community Edition) para Visor de Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b 0%, #020617 100%);
            height: 100vh;
            color: #e2e8f0;
            overflow: hidden;
            /* Ocultar contenido hasta verificar sesi√≥n */
            visibility: hidden;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
            color: white;
        }

        .submenu-item {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #3b82f6;
            padding-left: 1.25rem;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.2) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid rgba(255, 255, 255, 0.03);
            height: 100%;
        }

        .terminal-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 10px;
        }

        .mic-active {
            animation: pulse-red 1.5s infinite;
            color: #ef4444 !important;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .logo-container svg {
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }

        .chevron-icon {
            transition: transform 0.3s ease;
        }

        .menu-open .chevron-icon {
            transform: rotate(180deg);
        }

        /* Ajuste para el men√∫ que abre hacia arriba */
        .dropup-content {
            bottom: 100%;
            margin-bottom: 0.5rem;
        }

        /* ESTILOS MODAL PROVEEDORES */
        .modal-blur {
            backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.5);
        }

        .form-input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .btn-glow {
            transition: all 0.3s ease;
        }

        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="flex h-screen w-screen overflow-hidden">

    <!-- MEN√ö LATERAL IZQUIERDO -->
    <aside class="w-64 bg-slate-950/40 border-r border-slate-800 backdrop-blur-xl flex flex-col z-50 shrink-0">
        <div class="p-6 text-slate-400">
            <div class="flex items-center gap-3 mb-10 logo-container">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                    class="text-blue-500">
                    <path d="M12 22C12 22 20 18 20 12V5L12 2L4 5V12C4 18 12 22 12 22Z" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 15V9H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M9 15H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span class="font-bold tracking-tighter text-xl text-white">LAMDA</span>
            </div>

            <nav class="space-y-1">
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-4 ml-4">Panel de Control</p>

                <!-- 1. Gesti√≥n de listas -->
                <div id="listsMenuContainer">
                    <button onclick="toggleDropdown('listsDropdown', 'listsMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="list-checks" class="w-4 h-4"></i>
                            <span>Gesti√≥n de listas</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="listsDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="openSupplierModal()"
                            class="submenu-item text-left py-2 text-[11px] text-emerald-500 hover:text-emerald-400 text-xs font-semibold">+
                            Nuevo Proveedor</button>
                    </div>
                </div>

                <!-- 2. Tareas -->
                <div id="tasksMenuContainer">
                    <button onclick="toggleDropdown('tasksDropdown', 'tasksMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            <span>Tareas</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="tasksDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="taskAction('Generar pedidos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Generar
                            pedidos</button>
                        <button onclick="taskAction('Generar presupuestos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Generar
                            presupuestos</button>
                        <button onclick="taskAction('Solicitar informaci√≥n a proveedor')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Solicitar
                            informaci√≥n</button>
                        <button onclick="taskAction('Orden de devoluci√≥n')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Orden
                            de devoluci√≥n</button>
                        <button onclick="taskAction('Orden de pago')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Orden
                            de pago</button>
                    </div>
                </div>

                <!-- 3. Info -->
                <div id="infoMenuContainer">
                    <button onclick="toggleDropdown('infoDropdown', 'infoMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                            <span>Info</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="infoDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <!-- Proveedores (Desplegable) -->
                        <div>
                            <button onclick="handleProveedoresClick()"
                                class="w-full submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs flex items-center justify-between group">
                                <span>Proveedores</span>
                                <i data-lucide="chevron-down"
                                    class="w-2.5 h-2.5 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            </button>
                            <!-- Submen√∫ Din√°mico de Proveedores -->
                            <div id="suppliersSubmenu"
                                class="hidden flex flex-col pl-3 mt-1 space-y-1 border-l border-slate-800/50 mb-2">
                                <!-- Se llena din√°micamente con JS -->
                                <span class="text-[9px] text-slate-600 px-2 py-1 italic">Cargando...</span>
                            </div>
                        </div>
                        <button onclick="taskAction('Mercader√≠a en tr√°nsito')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Mercader√≠a
                            en tr√°nsito</button>
                        <button onclick="taskAction('Pedidos activos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Pedidos
                            activos</button>
                    </div>
                </div>

                <!-- 4. Gr√°ficos -->
                <div id="chartsMenuContainer">
                    <button onclick="toggleDropdown('chartsDropdown', 'chartsMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                            <span>Gr√°ficos</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="chartsDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="taskAction('Gr√°fico de Inversi√≥n')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Inversi√≥n</button>
                        <button onclick="taskAction('Gr√°fico de Pasivos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Pasivos</button>
                        <button onclick="taskAction('Gr√°fico de Activos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Activos</button>
                    </div>
                </div>
            </nav>
        </div>

        <div class="mt-auto p-6 space-y-4 relative">
            <!-- Desplegable de Configuraci√≥n (Hacia Arriba) -->
            <div id="settingsMenuContainer" class="relative">
                <!-- Submen√∫ que abre hacia arriba -->
                <div id="settingsDropdown"
                    class="hidden absolute dropup-content w-full flex flex-col pl-11 pr-4 py-2 space-y-1 bg-slate-900/80 backdrop-blur-xl rounded-xl border border-slate-800 overflow-hidden transition-all duration-300 shadow-2xl mb-2">
                    <button onclick="openSupplierModal()"
                        class="submenu-item text-left py-2 text-[11px] text-slate-400 hover:text-blue-400 text-xs font-medium">Alta
                        de proveedor</button>
                    <button id="logoutBtn"
                        class="submenu-item text-left py-2 text-[11px] text-red-400 hover:text-red-300 text-xs font-medium w-full flex items-center gap-2">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Cerrar Sesi√≥n
                    </button>
                </div>

                <button onclick="toggleDropdown('settingsDropdown', 'settingsMenuContainer')"
                    class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left transition-all">
                    <div class="flex items-center gap-3">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        <span>Configuraci√≥n</span>
                    </div>
                    <i data-lucide="chevron-up" class="w-3 h-3 chevron-icon"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- √ÅREA DE CONTENIDO PRINCIPAL -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">

        <!-- Header Superior -->
        <header
            class="h-16 flex items-center justify-between px-8 border-b border-slate-800/50 bg-slate-950/20 backdrop-blur-md shrink-0">
            <div>
                <h1 class="text-xs font-mono text-blue-500 tracking-widest uppercase">Sistema Operativo v4.0 // Alta
                    Gerencia</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="systemTime" class="text-xs font-mono text-slate-500">29_ENE_2026_22:40</div>
                <div class="h-4 w-[1px] bg-slate-800"></div>
                <div class="flex items-center gap-2">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-bold border border-slate-700 animate-pulse">
                        ...</div>
                    <span id="userEmail" class="text-xs text-slate-300">Cargando...</span>
                </div>
            </div>
        </header>

        <!-- Rejilla Principal -->
        <main class="flex-1 p-6 flex flex-col gap-4 overflow-hidden">

            <!-- Fila de M√©tricas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 h-20 shrink-0">
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="users" class="w-3 h-3"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Proveedores Activos</span>
                    </div>
                    <span class="text-lg font-bold text-slate-200">142</span>
                </div>
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="trending-up" class="w-3 h-3 text-emerald-500"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Inversi√≥n Mensual</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-[10px] text-slate-600 font-mono">$</span>
                        <span class="text-lg font-bold text-emerald-400">158.420.000</span>
                    </div>
                </div>
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="alert-circle" class="w-3 h-3 text-amber-500"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Deuda Total</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-[10px] text-slate-600 font-mono">$</span>
                        <span class="text-lg font-bold text-amber-500">24.150.800</span>
                    </div>
                </div>
            </div>

            <!-- Fila de An√°lisis -->
            <div class="flex-1 flex flex-col min-h-0 relative">
                <div id="reportDisplay"
                    class="flex-1 terminal-font text-[14px] text-slate-300 overflow-y-auto custom-scrollbar p-6 max-w-4xl mx-auto w-full">
                    <!-- Respuestas de la IA -->
                </div>
            </div>
        </main>

        <!-- TERMINAL DE CHAT -->
        <footer class="p-4 bg-slate-950/80 backdrop-blur-3xl border-t border-blue-500/20 shrink-0">
            <div class="max-w-5xl mx-auto relative flex items-center gap-3">
                <button onclick="toggleHistory()"
                    class="group bg-slate-900 border border-slate-800 p-3 rounded-xl transition-all">
                    <i data-lucide="history" class="w-4 h-4 text-slate-500 group-hover:text-blue-400"></i>
                </button>
                <div class="flex-grow relative flex items-center">
                    <input type="text" id="terminalInput" placeholder="Habla o escribe un comando para la IA..."
                        class="w-full bg-slate-900/50 border border-slate-800 focus:border-blue-500/50 rounded-xl py-3 pl-6 pr-20 outline-none terminal-font text-xs text-white placeholder:text-slate-600 transition-all">
                    <div class="absolute right-2 flex items-center gap-1">
                        <button id="micBtn" onclick="toggleVoice()"
                            class="p-2 text-slate-500 hover:text-white transition-all rounded-lg">
                            <i data-lucide="mic" class="w-4 h-4"></i>
                        </button>
                        <button onclick="sendToAI()"
                            class="p-2 text-blue-500 hover:text-blue-400 transition-all rounded-lg">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Cargador de IA -->
        <div id="aiLoader"
            class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 flex items-center gap-3 bg-blue-600/10 border border-blue-500/30 px-6 py-2 rounded-full backdrop-blur-md z-50">
            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></span>
            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
            <span class="text-[10px] font-mono text-blue-400 uppercase tracking-widest">IA_SINCRO</span>
        </div>

        <!-- Historial -->
        <div id="historyOverlay"
            class="hidden absolute inset-0 z-[60] flex items-center justify-center p-8 bg-black/40 backdrop-blur-2xl">
            <div
                class="glass-panel w-full max-w-4xl h-[60vh] rounded-3xl flex flex-col border border-blue-500/20 overflow-hidden">
                <div
                    class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950/50 text-[10px] font-bold uppercase tracking-widest">
                    <span class="px-2">Registros del Sistema</span>
                    <button onclick="toggleHistory()" class="text-slate-500 hover:text-red-400"><i data-lucide="x"
                            class="w-5 h-5"></i></button>
                </div>
                <div id="historyContent"
                    class="flex-grow overflow-y-auto p-6 space-y-4 custom-scrollbar terminal-font text-[11px]"></div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- COMPONENTE: MODAL ALTA DE PROVEEDOR ‚ú® -->
    <!-- ========================================== -->
    <div id="supplierModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-blur overflow-y-auto">
        <div
            class="glass-panel w-full max-w-2xl rounded-[2.5rem] border border-blue-500/20 shadow-2xl animate-in zoom-in-95 duration-300">

            <!-- Encabezado del Modal -->
            <div class="p-8 border-b border-slate-800/50 flex justify-between items-center bg-slate-950/20">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600/20 p-3 rounded-2xl">
                        <i data-lucide="user-plus" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white tracking-tight leading-none mb-1">Registro de Proveedor
                        </h2>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">Alta de Entidad
                            Operativa</p>
                    </div>
                </div>
                <button onclick="closeSupplierModal()"
                    class="text-slate-500 hover:text-white p-2 hover:bg-slate-800 rounded-xl transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Cuerpo del Formulario -->
            <form id="supplierForm" class="p-8 space-y-6">
                <!-- Fila 1: Identidad -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Empresa / Nombre
                            Comercial</label>
                        <input type="text" name="nombre" placeholder="Ej: Distribuidora Central" required
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CUIT</label>
                        <input type="text" name="cuit" placeholder="XX-XXXXXXXX-X"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Fila 2: Clasificaci√≥n -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Categor√≠a Operativa</label>
                    <select name="categoria"
                        class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm appearance-none cursor-pointer">
                        <option value="" class="bg-slate-900">Seleccionar rubro...</option>
                        <option value="Frutos Secos" class="bg-slate-900">Frutos Secos</option>
                        <option value="Enlatados" class="bg-slate-900">Enlatados</option>
                        <option value="Bebidas" class="bg-slate-900">Bebidas</option>
                        <option value="Log√≠stica" class="bg-slate-900">Log√≠stica / Transporte</option>
                    </select>
                </div>

                <!-- Fila 3: Vinculaci√≥n Drive -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Carpeta en Drive</label>
                        <div class="relative">
                            <i data-lucide="folder" class="absolute left-4 top-3.5 w-4 h-4 text-slate-600"></i>
                            <select name="drive_folder_id" id="driveFolderSelect"
                                class="w-full form-input bg-slate-900/40 rounded-xl pl-11 pr-4 py-3 text-sm appearance-none cursor-pointer text-slate-300">
                                <option value="">Cargando carpetas...</option>
                            </select>
                            <i data-lucide="chevron-down"
                                class="absolute right-4 top-4 w-3 h-3 text-slate-600 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="space-y-1 flex items-center h-full pt-6">
                        <label
                            class="flex items-center gap-3 cursor-pointer group px-4 py-3 rounded-xl hover:bg-slate-900/50 transition-colors w-full border border-transparent hover:border-slate-800">
                            <input type="checkbox" name="activo"
                                class="w-5 h-5 rounded-md border-slate-600 bg-slate-900/80 text-blue-600 focus:ring-blue-500/50 focus:ring-offset-0 transition-all"
                                checked>
                            <div class="flex flex-col">
                                <span
                                    class="text-xs font-bold text-slate-300 group-hover:text-blue-400 transition-colors">Proveedor
                                    Operativo</span>
                                <span class="text-[9px] text-slate-500">¬øHabilitar compras y gesti√≥n?</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Fila 4: Contacto -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Responsable</label>
                        <input type="text" name="contacto_nombre" placeholder="Nombre completo"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Email</label>
                        <input type="email" name="contacto_email" placeholder="ejemplo@mail.com"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Tel√©fono</label>
                        <input type="tel" name="contacto_telefono" placeholder="+54 9..."
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Fila 4: Log√≠stica -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Direcci√≥n de Operaciones</label>
                    <div class="relative">
                        <i data-lucide="map-pin" class="absolute left-4 top-3.5 w-4 h-4 text-slate-600"></i>
                        <input type="text" name="direccion" placeholder="Calle, Altura, Localidad"
                            class="w-full form-input bg-slate-900/40 rounded-xl pl-11 pr-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Acciones -->
                <div class="pt-6 flex items-center justify-end gap-4">
                    <button type="button" onclick="closeSupplierModal()"
                        class="px-6 py-3 text-xs font-bold text-slate-500 hover:text-slate-300 transition-all uppercase tracking-widest">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="btn-glow px-8 py-3 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg shadow-blue-900/20">
                        Registrar Proveedor
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- COMPONENTE: MODAL VISOR UNIVERSAL (NUEVO) üëÅÔ∏è -->
    <!-- ========================================== -->
    <div id="viewerModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center p-2 modal-blur overflow-hidden">
        <div
            class="glass-panel w-[98vw] h-[98vh] rounded-2xl border border-blue-500/20 shadow-2xl flex flex-col animate-in zoom-in-95 duration-300">

            <!-- Header Visor -->
            <div
                class="px-6 py-4 border-b border-slate-800/50 flex justify-between items-center bg-slate-950/40 shrink-0">
                <div class="flex items-center gap-4">
                    <div id="viewerIconContainer" class="p-2 rounded-xl bg-slate-800/50">
                        <i id="viewerIcon" data-lucide="file" class="w-5 h-5 text-slate-400"></i>
                    </div>
                    <div>
                        <h2 id="viewerTitle" class="text-sm font-bold text-white tracking-wide">Documento</h2>
                        <p class="text-[10px] text-slate-500 font-mono tracking-wider">MODO LECTURA</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btnExtractFromViewer"
                        class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold uppercase tracking-widest rounded-lg transition-colors flex items-center gap-2">
                        <i data-lucide="cpu" class="w-3 h-3"></i> Procesar con IA
                    </button>
                    <div class="h-6 w-[1px] bg-slate-800 mx-2"></div>
                    <button onclick="closeViewerModal()"
                        class="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Cuerpo Visor -->
            <div id="viewerContent" class="flex-grow bg-slate-100 relative overflow-hidden flex flex-col">
                <!-- Loader -->
                <div id="viewerLoader"
                    class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 z-50">
                    <i data-lucide="loader-2" class="w-10 h-10 text-blue-500 animate-spin mb-3"></i>
                    <p class="text-xs text-blue-400 font-mono animate-pulse">DESCARGANDO STREAM...</p>
                </div>

                <!-- Contenedores por Tipo -->
                <div id="sheetTabs"
                    class="hidden w-full bg-slate-800 border-b border-blue-500/20 px-2 py-1 flex gap-1 overflow-x-auto custom-scrollbar">
                    <!-- Tabs se inyectan ac√° -->
                </div>
                <div id="excelContainer"
                    class="hidden w-full h-full overflow-auto bg-slate-900 text-slate-300 text-xs font-mono p-1"></div>
                <iframe id="pdfContainer" class="hidden w-full h-full border-0"></iframe>
                <div id="imageContainer"
                    class="hidden w-full h-full flex items-center justify-center bg-slate-900 overflow-auto">
                    <img id="viewerImage" class="max-w-full max-h-full object-contain shadow-2xl" />
                </div>
                <div id="errorContainer"
                    class="hidden w-full h-full flex flex-col items-center justify-center bg-slate-900 text-red-400">
                    <i data-lucide="alert-triangle" class="w-12 h-12 mb-4"></i>
                    <p id="viewerErrorMessage" class="text-sm font-bold">Error al cargar archivo</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Integraci√≥n de L√≥gica y Seguridad -->
    <script>
        lucide.createIcons();

        // 1. Configuraci√≥n de Seguridad y Backend
        const sbUrl = (typeof CONFIG !== 'undefined') ? CONFIG.SUPABASE_URL : "";
        const sbKey = (typeof CONFIG !== 'undefined') ? CONFIG.SUPABASE_ANON_KEY : "";
        // Usar API Key real de config.js para la IA
        const apiKey = (typeof CONFIG !== 'undefined') ? CONFIG.GEMINI_API_KEY : "";

        // Renombrado a supabaseClient para evitar conflicto con window.supabase
        let supabaseClient = null;

        // 2. Guardia de Sesi√≥n (Protecci√≥n de Ruta)
        async function initSystem() {
            if (!sbUrl || !sbKey) {
                console.error("CRITICAL: Faltan credenciales del sistema.");
                window.location.href = 'acceso.html'; // Expulsi√≥n preventiva
                return;
            }

            // Inicializar Cliente Supabase
            supabaseClient = window.supabase.createClient(sbUrl, sbKey);

            // Verificar Sesi√≥n Activa
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session) {
                // Si no hay sesi√≥n, REDIRIGIR AL LOGIN
                console.warn("‚ö†Ô∏è Acceso no autorizado. Redirigiendo a puerta de enlace...");
                window.location.href = 'acceso.html';
            } else {
                // Sesi√≥n V√°lida: Mostrar Interfaz y Cargar Datos
                document.body.style.visibility = 'visible';
                console.log("‚úÖ Sistema Operativo. Usuario:", session.user.email);

                // Actualizar UI con datos de usuario
                document.getElementById('userEmail').innerText = session.user.email;
                document.getElementById('userAvatar').innerText = session.user.email.substring(0, 2).toUpperCase();
                document.getElementById('userAvatar').classList.remove('animate-pulse'); // Stop loading animation

                // Cargar Sidebar de Proveedores (Lazy Load inicial)
                loadSuppliersSidebar();
            }

            // Listener de Auth State Change (para logout global)
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') window.location.href = 'acceso.html';
            });
        }

        // Ejecutar Inmediatamente
        initSystem();

        // 3. L√≥gica del Chasis (Interfaz Original del Chapista)
        const terminalInput = document.getElementById('terminalInput');
        const aiLoader = document.getElementById('aiLoader');
        const historyContent = document.getElementById('historyContent');
        const micBtn = document.getElementById('micBtn');
        const reportDisplay = document.getElementById('reportDisplay');
        const logoutBtn = document.getElementById('logoutBtn');

        // Logout
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'acceso.html';
            });
        }

        // Placeholder for real metrics, assuming it will be fetched or calculated
        let realMetrics = {
            proveedoresCount: 142, // Example initial value
            inversion: "$158.420.000 Pesos",
            deuda: "$24.150.800 Pesos"
        };

        // Estado Global de Proveedores
        let currentSuppliers = [];
        let editingSupplierId = null;

        // --- EXPLORADOR DE ARCHIVOS (DRIVE) ---
        async function exploreSupplierFiles(folderId) {
            if (!folderId) return;

            // Mostrar estado de carga en el panel central
            reportDisplay.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-blue-400 animate-in fade-in duration-300">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                        <i data-lucide="hard-drive" class="absolute inset-0 m-auto w-6 h-6 text-white animate-pulse"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1">Conectando con Drive</h3>
                    <p class="text-xs text-slate-500 font-mono">ID: ${folderId}</p>
                </div>
            `;
            lucide.createIcons();

            try {
                // Fetch archivos usando la URL base (backendBaseUrl ya definido anteriormente)
                const url = backendBaseUrl ? `${backendBaseUrl}/api/files/list?folderId=${folderId}` : `/api/files/list?folderId=${folderId}`;

                const res = await fetch(url);
                const data = await res.json();

                if (!data.success) throw new Error(data.error || "Error desconocido");

                renderFileGrid(data.files, folderId);

            } catch (error) {
                console.error("Error explorador:", error);
                reportDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400">
                        <i data-lucide="alert-triangle" class="w-12 h-12 mb-4 opacity-80"></i>
                        <p class="text-lg font-bold">Error de Conexi√≥n</p>
                        <p class="text-sm text-slate-500 max-w-md text-center mt-2">${error.message}</p>
                        <button onclick="showSuppliersList()" class="mt-6 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs transition-colors">Volver</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderFileGrid(files, folderId) {
            // Helpers de Iconos
            const getIcon = (mime) => {
                if (mime.includes('folder')) return 'folder';
                if (mime.includes('image')) return 'image';
                if (mime.includes('pdf')) return 'file-text';
                if (mime.includes('spreadsheet') || mime.includes('excel') || mime.includes('csv')) return 'table';
                return 'file';
            };

            const getColor = (mime) => {
                if (mime.includes('folder')) return 'text-yellow-500';
                if (mime.includes('image')) return 'text-purple-400';
                if (mime.includes('pdf')) return 'text-red-400';
                if (mime.includes('spreadsheet')) return 'text-emerald-400';
                return 'text-slate-400';
            };

            // Header con Navegaci√≥n
            let html = `
                <div class="h-full flex flex-col animate-in slide-in-from-bottom-4 duration-500 p-2">
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-800">
                        <div class="flex items-center gap-3">
                            <button onclick="showSuppliersList()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                    <i data-lucide="folder-open" class="w-5 h-5 text-blue-500"></i>
                                    Archivos del Proveedor
                                </h2>
                                <span class="text-[10px] text-slate-500 font-mono tracking-wider">INDEXANDO ${files.length} ELEMENTOS</span>
                            </div>
                        </div>
                        <a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-blue-600/20 text-slate-300 hover:text-blue-400 border border-slate-700 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                            Drive Exte&shy;rno <i data-lucide="external-link" class="w-3 h-3"></i>
                        </a>
                    </div>
            `;

            // Grid de Contenido
            if (files.length === 0) {
                html += `
                    <div class="flex-grow flex flex-col items-center justify-center text-slate-600">
                        <i data-lucide="folder-open" class="w-16 h-16 mb-4 opacity-20"></i>
                        <p class="text-sm">Carpeta vac√≠a</p>
                    </div>
                `;
            } else {
                html += `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto custom-scrollbar pr-2 pb-10">`;

                files.forEach(file => {
                    const iconName = getIcon(file.mimeType);
                    const colorClass = getColor(file.mimeType);

                    html += `
                        <div onclick="handleFileClick('${file.id}', '${file.name}')" class="cursor-pointer group relative bg-slate-900/40 hover:bg-slate-900/80 border border-slate-800 hover:border-blue-500/30 rounded-xl p-4 flex flex-col items-center gap-3 transition-all hover:-translate-y-1 hover:shadow-xl hover:shadow-blue-900/10">
                            <!-- External Link (Corner) -->
                            <a href="${file.webViewLink}" target="_blank" onclick="event.stopPropagation()" class="absolute top-2 right-2 p-1 text-slate-600 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity" title="Abrir en Drive">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                            </a>
                            
                            <!-- Icon -->
                            <div class="w-12 h-12 rounded-2xl bg-slate-800 flex items-center justify-center mb-2 group-hover:scale-110 transition-transform shadow-lg ${colorClass.replace('text-', 'shadow-').replace('400', '900')}/20">
                                <i data-lucide="${iconName}" class="w-6 h-6 ${colorClass}"></i>
                            </div>
                            
                            <!-- Name -->
                            <p class="text-[10px] text-center text-slate-300 font-medium line-clamp-2 w-full px-1 group-hover:text-white transition-colors">${file.name}</p>
                            
                            <!-- Date -->
                            <span class="text-[9px] text-slate-600 font-mono mt-auto">${new Date(file.modifiedTime).toLocaleDateString()}</span>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            reportDisplay.innerHTML = html;
            lucide.createIcons();
        }

        async function handleFileClick(fileId, fileName) {
            console.log("Abriendo visor para:", fileName);
            openFileViewer(fileId, fileName);
        }

        // --- L√ìGICA DEL VISOR OPTIMIZADA (WORKER + VIRTUALIZATION) ---
        let viewerWorker = null;
        let currentSheetData = []; // Datos crudos en memoria (Main Thread)

        async function openFileViewer(fileId, fileName) {
            // UI Elements
            const modal = document.getElementById('viewerModal');
            const loader = document.getElementById('viewerLoader');
            const title = document.getElementById('viewerTitle');
            const excelContainer = document.getElementById('excelContainer');
            const sheetTabs = document.getElementById('sheetTabs');
            const errContainer = document.getElementById('errorContainer');
            const pdfContainer = document.getElementById('pdfContainer');
            const imgContainer = document.getElementById('imageContainer');
            const imgEl = document.getElementById('viewerImage');
            const btnExtract = document.getElementById('btnExtractFromViewer');

            // 1. LIMPIEZA TOTAL (Memory Management)
            if (window.viewerWorker) {
                window.viewerWorker.terminate();
                window.viewerWorker = null;
            }
            // Worker se inicia solo si es Excel ahora

            currentSheetData = [];
            excelContainer.onscroll = null;
            excelContainer.innerHTML = '';
            sheetTabs.innerHTML = '';

            // Hide All
            [excelContainer, sheetTabs, pdfContainer, imgContainer, errContainer].forEach(el => el && el.classList.add('hidden'));
            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            title.textContent = fileName;
            btnExtract.classList.add('hidden');

            try {
                const downloadUrl = `${backendBaseUrl || ''}/api/files/download/${fileId}`;
                const isExcel = fileName.match(/\.(xlsx|xls|csv)$/i);
                const isPdf = fileName.match(/\.pdf$/i);
                const isImg = fileName.match(/\.(jpg|jpeg|png)$/i);

                if (isExcel) {
                    // Descargar ArrayBuffer
                    const response = await fetch(downloadUrl);
                    if (!response.ok) throw new Error("Error descargando archivo.");
                    const arrayBuffer = await response.arrayBuffer();

                    // Iniciar Worker
                    window.viewerWorker = new Worker('./worker.js'); // Global Scope
                    window.viewerWorker.postMessage({ type: 'INIT_FILE', payload: arrayBuffer });

                    // --- WORKER MANAGEMENT & FALLBACK ---
                    let useWorker = true;

                    const processLocally = (wb, sName) => {
                        console.warn("‚ö†Ô∏è Fallback Local activado para: " + sName);
                        const excelContainer = document.getElementById('excelContainer');
                        const loader = document.getElementById('loader');

                        try {
                            if (!workbook && typeof wb !== 'undefined') workbook = wb;
                            if (!workbook && typeof XLSX !== 'undefined' && typeof arrayBuffer !== 'undefined') {
                                // Intento de rescate final
                                try { workbook = XLSX.read(arrayBuffer); } catch (e) { }
                            }

                            if (!workbook) throw new Error("No se pudo recuperar el archivo Excel para procesamiento local.");

                            // Fallback Rescue for empty sheet name (New Logic)
                            if ((!sName || sName === "") && workbook.SheetNames.length > 0) {
                                sName = workbook.SheetNames[0];
                            }

                            const ws = workbook.Sheets[sName];
                            if (!ws) throw new Error("Hoja '" + sName + "' no encontrada.");

                            // Usamos sheet_to_json igual que el worker para consistencia
                            const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                            currentSheetData = json;
                            renderVirtualTable(json);
                            loader.classList.add('hidden');

                            // Actualizar UI para indicar modo local
                            const spinner = excelContainer.querySelector('.animate-spin');
                            if (spinner && spinner.nextElementSibling) {
                                spinner.nextElementSibling.textContent = "VISTA LOCAL (SAFE MODE)";
                            }

                        } catch (e) {
                            console.error("Local Processing Error:", e);
                            const errContainer = document.getElementById('errContainer');
                            errContainer.textContent = "Error en Modo Seguro: " + e.message;
                            errContainer.classList.remove('hidden');
                            loader.classList.add('hidden');
                        }
                    };

                    window.viewerWorker.onerror = (e) => {
                        console.error("üö® Worker Crash/Error:", e);
                        useWorker = false;
                        e.preventDefault();
                        window.viewerWorker.terminate();

                        // Intentar recuperar sesi√≥n
                        if (currentSheetName) {
                            processLocally(workbook, currentSheetName);
                        } else if (workbook && workbook.SheetNames.length > 0) {
                            loadSheet(workbook.SheetNames[0]);
                        } else {
                            // Si crashe√≥ antes de tener workbook, intentar leerlo
                            processLocally(null, ""); // Trigger rescue attempt inside
                        }
                    };

                    // Escuchar al Obrero
                    window.viewerWorker.onmessage = (e) => {
                        const { type, payload } = e.data;

                        if (type === 'SHEETS_READY') {
                            // Payload = Lista de hojas
                            const sheetNames = payload;
                            if (sheetNames.length === 0) throw new Error("Excel vac√≠o.");

                            // Renderizar Tabs
                            sheetNames.forEach((sheetName, index) => {
                                const btn = document.createElement('button');
                                btn.innerText = sheetName;
                                btn.className = `px-3 py-1.5 text-[10px] font-bold uppercase rounded-t-lg transition-colors border-b-2 ${index === 0 ? 'bg-slate-700 text-blue-400 border-blue-500' : 'bg-slate-900 text-slate-500 border-transparent hover:text-slate-300'}`;

                                btn.onclick = () => {
                                    // UI Tabs Update
                                    Array.from(sheetTabs.children).forEach(c => {
                                        c.classList.remove('bg-slate-700', 'text-blue-400', 'border-blue-500');
                                        c.classList.add('bg-slate-900', 'text-slate-500', 'border-transparent');
                                    });
                                    btn.classList.remove('bg-slate-900', 'text-slate-500', 'border-transparent');
                                    btn.classList.add('bg-slate-700', 'text-blue-400', 'border-blue-500');

                                    // SOLICITAR PROCESAMIENTO AL WORKER
                                    loadSheet(sheetName);
                                };
                                sheetTabs.appendChild(btn);
                            });

                            if (sheetNames.length > 1) sheetTabs.classList.remove('hidden');
                            excelContainer.classList.remove('hidden');

                            // Cargar primera hoja
                            loadSheet(sheetNames[0]);
                            loader.classList.add('hidden');

                        } else if (type === 'SHEET_DATA_READY') {
                            // Payload = { sheetName, data }
                            currentSheetData = payload.data;
                            renderVirtualTable(currentSheetData);

                        } else if (type === 'ERROR') {
                            console.error("Worker Error L√≥gico:", payload);
                            // Fallback manual si el worker expl√≠citamente falla
                            useWorker = false;

                            // Intentamos leer el workbook localmente si no existe
                            if (!workbook) {
                                try { workbook = XLSX.read(arrayBuffer); } catch (e) { }
                            }
                            // Trigger fallback
                            if (currentSheetName) processLocally(workbook, currentSheetName);
                            else if (workbook) loadSheet(workbook.SheetNames[0]);
                            else {
                                errContainer.textContent = payload;
                                errContainer.classList.remove('hidden');
                                loader.classList.add('hidden');
                            }
                        }
                    };

                } else if (isPdf) {
                    pdfContainer.src = downloadUrl;
                    pdfContainer.classList.remove('hidden');
                    loader.classList.add('hidden');
                } else if (isImg) {
                    imgEl.src = downloadUrl;
                    imgContainer.classList.remove('hidden');
                    loader.classList.add('hidden');
                } else {
                    throw new Error("Formato no soportado.");
                }

            } catch (error) {
                console.error(error);
                errContainer.textContent = error.message;
                errContainer.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // --- L√≥gica del Capataz (Gesti√≥n de UI) ---
        function loadSheet(sheetName) {
            // Global scope helper for tabs
            window.loadSheet = loadSheet; // Ensure it's available globally

            const excelContainer = document.getElementById('excelContainer');

            // Limpieza de Memoria VISUAL
            excelContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-blue-400">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                <span class="text-xs font-mono animate-pulse">${(typeof useWorker !== 'undefined' && useWorker) ? 'PROCESANDO... (WORKER)' : 'PROCESANDO... (LOCAL)'}</span>
            </div>`;

            currentSheetData = null; // Liberar ref anterior
            currentSheetName = sheetName;

            if (typeof useWorker !== 'undefined' && useWorker) {
                viewerWorker.postMessage({ type: 'PARSE_SHEET', payload: sheetName });

                // Watchdog para detectar hangs
                setTimeout(() => {
                    if (currentSheetData === null && useWorker && document.getElementById('excelContainer').innerHTML.includes('border-t-transparent')) {
                        console.warn("Worker timeout. Intentando modo local...");
                        if (typeof processLocally === 'function') processLocally(workbook, sheetName);
                    }
                }, 5000);
            } else {
                // Fallback Logic
                setTimeout(() => {
                    if (typeof processLocally === 'function') processLocally(workbook, sheetName);
                }, 50);
            }
        }

        // --- VIRTUAL SCROLLER (Establizar Renderizado) ---
        function renderVirtualTable(data) {
            const container = document.getElementById('excelContainer');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-slate-500 p-4">Hoja vac√≠a</div>';
                return;
            }

            // Configuraci√≥n Virtual
            const ROW_HEIGHT = 35; // px aprox por fila
            const HEADER_HEIGHT = 40; // px
            const totalRows = data.length;
            const totalHeight = (totalRows * ROW_HEIGHT) + HEADER_HEIGHT;

            // 1. Crear Scroller Dummy (El fantasma que da altura)
            container.innerHTML = '';
            const scrollerContent = document.createElement('div');
            scrollerContent.style.height = `${totalHeight}px`;
            scrollerContent.style.position = 'relative';
            container.appendChild(scrollerContent);

            // 2. Tabla Visible (Posici√≥n absoluta que se mueve)
            const table = document.createElement('table');
            table.className = 'w-full border-collapse text-[11px] font-mono absolute top-0 left-0';
            table.style.tableLayout = 'fixed'; // Importante para rendimiento
            scrollerContent.appendChild(table);

            const thead = document.createElement('thead');
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);

            // Render Header Una sola vez
            const headerRow = data[0];
            let headerHtml = `<tr style="height: ${HEADER_HEIGHT}px">`;
            headerRow.forEach(cell => {
                headerHtml += `<th class="bg-slate-800 text-blue-400 font-bold uppercase border border-slate-700 p-2 sticky top-0 z-20 text-left overflow-hidden text-ellipsis whitespace-nowrap" style="height: ${HEADER_HEIGHT}px">${cell || ''}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Funci√≥n de Pintado Parcial
            const updateVisibleRows = () => {
                const scrollTop = container.scrollTop;
                const viewportHeight = container.clientHeight;

                const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
                const endIndex = Math.min(startIndex + Math.ceil(viewportHeight / ROW_HEIGHT) + 5, totalRows); // +5 buffer

                // Ajustamos la posici√≥n de TODA la tabla
                const offsetY = startIndex * ROW_HEIGHT;
                table.style.transform = `translateY(${offsetY}px)`;

                let rowsHtml = '';
                // Empezamos de 1 si index < 1 (Data[0] es header)
                const startDataIndex = Math.max(1, startIndex);

                for (let i = startDataIndex; i < endIndex; i++) {
                    const row = data[i];
                    if (!row) continue;

                    rowsHtml += `<tr style="height: ${ROW_HEIGHT}px;" class="hover:bg-slate-800/50">`;
                    for (let j = 0; j < headerRow.length; j++) {
                        const cellVal = row[j] !== undefined ? row[j] : '';
                        let cellClass = 'border border-slate-800 p-2 whitespace-nowrap text-slate-400 overflow-hidden text-ellipsis';
                        if (typeof cellVal === 'number' || (!isNaN(Number(cellVal)) && cellVal !== '')) {
                            cellClass += ' text-emerald-400 text-right';
                        }
                        rowsHtml += `<td class="${cellClass}">${cellVal}</td>`;
                    }
                    rowsHtml += '</tr>';
                }

                tbody.innerHTML = rowsHtml;
            };

            // Iniciar Scroll Listener
            container.onscroll = () => {
                requestAnimationFrame(updateVisibleRows);
            };

            // Primer pintado
            updateVisibleRows();
        }

        function closeViewerModal() {
            document.getElementById('viewerModal').classList.add('hidden');
            document.getElementById('pdfContainer').src = ""; // Limpiar iframe
            document.getElementById('viewerImage').src = "";
            document.getElementById('excelContainer').innerHTML = "";
        }


        // Alias para compatibilidad con instrucciones de usuario
        async function showSuppliersList() {
            await loadProveedores();
        }

        // --- L√ìGICA DE NAVEGACI√ìN DIN√ÅMICA DE PROVEEDORES ---

        function handleProveedoresClick() {
            const submenu = document.getElementById('suppliersSubmenu');
            // Toggle visibilidad
            submenu.classList.toggle('hidden');

            // Cargar lista si est√° vac√≠o (lazy load)
            if (!submenu.classList.contains('hidden')) { // Si se abre
                loadSuppliersSidebar();
            }
            // Mostrar lista general en el centro
            showSuppliersList();
        }

        async function loadSuppliersSidebar() {
            const container = document.getElementById('suppliersSubmenu');

            const { data, error } = await supabaseClient
                .from('proveedores')
                .select('id, nombre')
                .eq('activo', true) // Solo activos en sidebar? O todos? Usuario dijo "todos los proveedores".
                .order('nombre', { ascending: true });

            if (error) {
                console.error("Error sidebar:", error);
                container.innerHTML = '<span class="text-[9px] text-red-400 px-2">Error</span>';
                return;
            }

            container.innerHTML = ''; // Limpiar

            if (data.length === 0) {
                container.innerHTML = '<span class="text-[9px] text-slate-600 px-2 italic">Sin proveedores</span>';
                return;
            }

            data.forEach(p => {
                const btn = document.createElement('button');
                btn.onclick = (e) => {
                    e.stopPropagation(); // Evitar cerrar men√∫ si fuera necesario
                    showSingleSupplier(p.id);
                };
                btn.className = "text-left py-1.5 px-2 text-[10px] text-slate-500 hover:text-blue-400 hover:bg-slate-900/50 rounded transition-colors whitespace-nowrap overflow-hidden text-ellipsis";
                btn.innerText = p.nombre;
                container.appendChild(btn);
            });
        }

        async function showSingleSupplier(id) {
            // Set Global Context for File Operations
            window.currentActiveProviderId = id;

            // Buscar datos completos (Optimizaci√≥n: buscar en cache local si existe, o fetch)
            let supplier = currentSuppliers.find(s => s.id === id);

            if (!supplier) {
                // Fetch on demand si no est√° en cache
                reportDisplay.innerHTML = `< div class="flex items-center justify-center h-full text-blue-400" > <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-2"></i> Cargando ficha...</div > `;
                lucide.createIcons();
                const { data } = await supabaseClient.from('proveedores').select('*').eq('id', id).single();
                supplier = data;
            }

            if (!supplier) {
                reportDisplay.innerHTML = '<div class="text-red-500">Proveedor no encontrado</div>';
                return;
            }

            // Renderizar Ficha T√©cnica
            reportDisplay.innerHTML = `
            < div class="h-full flex flex-col animate-in fade-in zoom-in-95 duration-300 p-2" >
                    < !--Header Ficha-- >
                    <div class="flex justify-between items-start mb-8 border-b border-slate-800 pb-6">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-3xl font-bold text-white tracking-tight">${supplier.nombre}</h2>
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-widest">${supplier.categoria || 'GENERAL'}</span>
                            </div>
                            <div class="flex items-center gap-4 text-slate-500 text-xs font-mono">
                                <span>CUIT: <span class="text-slate-400">${supplier.cuit || 'N/A'}</span></span>
                                <span>‚Ä¢</span>
                                <span>ID: ${supplier.id.substring(0, 8)}</span>
                            </div>
                        </div>
                        <button onclick="editSupplier('${supplier.id}')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700/50 rounded-lg text-xs font-bold transition-all flex items-center gap-2 group">
                            <i data-lucide="pencil" class="w-3 h-3 group-hover:text-white transition-colors"></i> EDITAR
                        </button>
                    </div>

                    <!--Grid de Informaci√≥n-- >
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- Columna 1: Operativa e Infra -->
                <div class="space-y-6">
                    <!-- Estado -->
                    <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-colors"></div>
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="activity" class="w-3 h-3"></i> Estado Operativo
                        </h3>
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${supplier.activo ? 'bg-emerald-500 shadow-[0_0_12px_rgba(16,185,129,0.4)]' : 'bg-red-500 shadow-[0_0_12px_rgba(239,68,68,0.4)]'}"></div>
                            <span class="text-sm font-medium ${supplier.activo ? 'text-emerald-400' : 'text-red-400'}">
                                ${supplier.activo ? 'ACTIVO Y VALIDADO' : 'SUSPENDIDO / INACTIVO'}
                            </span>
                        </div>
                    </div>

                    <!-- Drive -->
                    <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="hard-drive" class="w-3 h-3"></i> Digital Assets
                        </h3>
                        ${supplier.drive_folder_id
                    ? `<div onclick="exploreSupplierFiles('${supplier.drive_folder_id}')" class="flex items-center justify-between p-3 bg-slate-950/50 rounded-lg border border-slate-800 group hover:border-blue-500/30 transition-colors cursor-pointer">
                                        <div class="flex items-center gap-3">
                                            <div class="p-2 bg-slate-900 rounded-md text-blue-500">
                                                <i data-lucide="folder" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-xs font-bold text-slate-300 group-hover:text-white transition-colors">Carpeta Vinculada</span>
                                                <span class="text-[9px] text-slate-600 font-mono">${supplier.drive_folder_id}</span>
                                            </div>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-600 group-hover:text-blue-400 transition-colors"></i>
                                       </div>`
                    : `<div class="text-xs text-slate-600 italic py-2">Sin carpeta vinculada</div>`
                }
                    </div>
                </div>

                <!-- Columna 2: Contacto y Datos -->
                <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50 h-full">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i data-lucide="user-check" class="w-3 h-3"></i> Contacto y Log√≠stica
                    </h3>

                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="block text-[9px] text-slate-500 uppercase mb-1">Responsable</span>
                                <span class="text-sm text-slate-300 font-medium border-b border-transparent hover:border-blue-500/50 transition-colors inline-block pb-0.5">
                                    ${supplier.contacto_nombre || '-'}
                                </span>
                            </div>
                            <div>
                                <span class="block text-[9px] text-slate-500 uppercase mb-1">Tel√©fono</span>
                                <span class="text-sm text-slate-300 font-mono">${supplier.contacto_telefono || '-'}</span>
                            </div>
                        </div>

                        <div>
                            <span class="block text-[9px] text-slate-500 uppercase mb-1">Email Corporativo</span>
                            <a href="mailto:${supplier.contacto_email}" class="flex items-center gap-2 text-sm text-blue-400/80 hover:text-blue-400 transition-colors">
                                <i data-lucide="mail" class="w-3 h-3"></i>
                                ${supplier.contacto_email || '-'}
                            </a>
                        </div>

                        <div class="pt-4 border-t border-slate-800/50">
                            <span class="block text-[9px] text-slate-500 uppercase mb-1">Direcci√≥n Operativa</span>
                            <div class="flex items-start gap-2 text-slate-400 text-xs">
                                <i data-lucide="map-pin" class="w-3 h-3 mt-0.5 shrink-0 text-slate-600"></i>
                                ${supplier.direccion || 'Sin direcci√≥n registrada'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div >
            `;
            lucide.createIcons();
        }


        // L√≥gica para cargar proveedores (asumiendo que se obtienen de Supabase)
        async function loadProveedores() {
            reportDisplay.innerHTML = `< div class="flex items-center justify-center h-full text-blue-400" >
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mr-2"></i>
                                        Cargando proveedores...
                                    </div > `;
            lucide.createIcons();

            const { data, error } = await supabaseClient
                .from('proveedores')
                .select('*')
                .order('nombre', { ascending: true }); // Orden alfab√©tico

            if (error) {
                console.error("Error al cargar proveedores:", error);
                reportDisplay.innerHTML = `< div class="text-red-500" > Error al cargar proveedores: ${error.message}</div > `;
                return;
            }

            // Actualizar estado local
            currentSuppliers = data;

            // Actualizar m√©tricas reales
            realMetrics.proveedoresCount = data.length;

            if (data.length === 0) {
                reportDisplay.innerHTML = `
            < div class="flex flex-col items-center justify-center h-full text-slate-500" >
                        <i data-lucide="inbox" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p class="text-sm">No hay proveedores registrados.</p>
                        <button onclick="openSupplierModal()" class="mt-4 px-4 py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 rounded-lg text-xs transition-colors border border-blue-500/30">
                            + Dar de Alta
                        </button>
                    </div >
            `;
            } else {
                // Renderizar la tabla de proveedores
                let tableHtml = `
            < div class="flex justify-between items-center mb-4" >
                        <h3 class="text-xl font-bold text-white">Listado de Proveedores</h3>
                        <span class="text-xs text-slate-500 font-mono">${data.length} REGISTROS</span>
                    </div >
            <div class="overflow-x-auto custom-scrollbar rounded-xl border border-slate-800">
                <table class="min-w-full divide-y divide-slate-800 bg-slate-900/40">
                    <thead class="bg-slate-950/50">
                        <tr>
                            <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Empresa</th>
                            <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden md:table-cell">CUIT</th>
                            <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Categor√≠a</th>
                            <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden md:table-cell">Contacto</th>
                            <th class="px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-widest">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800/50">
                        `;
                data.forEach(supplier => {
                    tableHtml += `
                        <tr class="hover:bg-blue-600/5 transition-colors group">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-xs font-bold text-white">${supplier.nombre}</div>
                                <div class="text-[10px] text-slate-500 md:hidden">${supplier.cuit || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-xs text-slate-400 font-mono hidden md:table-cell">${supplier.cuit || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-slate-800 text-slate-300 border border-slate-700 uppercase">
                                    ${supplier.categoria || 'General'}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap hidden md:table-cell">
                                <div class="text-xs text-slate-300">${supplier.contacto_nombre || '-'}</div>
                                <div class="text-[10px] text-slate-500">${supplier.contacto_email || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editSupplier('${supplier.id}')" class="p-1.5 hover:bg-blue-500/20 text-blue-400 rounded-lg transition-colors border border-transparent hover:border-blue-500/30" title="Editar">
                                        <i data-lucide="pencil" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="deleteSupplier('${supplier.id}', '${supplier.nombre}')" class="p-1.5 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors border border-transparent hover:border-red-500/30" title="Eliminar">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                    </tbody>
                </table>
            </div>
        `;
                reportDisplay.innerHTML = tableHtml;
            }
            lucide.createIcons();
            // Update realMetrics with actual count
            realMetrics.proveedoresCount = data.length;
        }

        // L√≥gica de M√©tricas Contextuales Actualizada (ZERO HALLUCINATIONS)
        const getMetricsContext = () => {
            return {
                proveedores: `${realMetrics.proveedoresCount} registrados en base de datos.`,
                inversion: realMetrics.inversion,
                deuda: realMetrics.deuda
            };
        };

        // L√ìGICA DE VINCULACI√ìN DRIVE
        let driveFoldersCache = null;
        const backendBaseUrl = (typeof CONFIG !== 'undefined' && CONFIG.BACKEND_URL) ? CONFIG.BACKEND_URL : "";

        async function loadDriveFolders() {
            const select = document.getElementById('driveFolderSelect');
            // Si ya hay opciones (adem√°s del placeholder), no recargar agresivamente, salvo que sea la primera vez real
            if (driveFoldersCache && select.children.length > 1) return;

            try {
                // Fetch using absolute path (if config exists) or relative (fallback)
                const url = backendBaseUrl ? `${backendBaseUrl} /api/files / list ? type = folders` : '/api/files/list?type=folders';

                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    driveFoldersCache = data.files;
                    populateSelect(select, driveFoldersCache);
                } else {
                    select.innerHTML = '<option value="">Error cargando carpetas</option>';
                }
            } catch (e) {
                console.error("Error loading folders:", e);
                select.innerHTML = '<option value="">Error de conexi√≥n con Drive</option>';
            }
        }

        function populateSelect(select, files) {
            const currentVal = select.value;
            select.innerHTML = '<option value="">Sin vinculaci√≥n (Seleccionar carpeta)</option>';
            files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.innerText = f.name;
                select.appendChild(opt);
            });
            // Restaurar valor si exist√≠a (√∫til en ediciones r√°pidas)
            if (currentVal) select.value = currentVal;
        }

        // L√ìGICA MODAL PROVEEDORES + SUPABASE INTEGRATION
        const modal = document.getElementById('supplierModal');
        const form = document.getElementById('supplierForm');

        const modalTitle = modal.querySelector('h2');
        const modalSubtitle = modal.querySelector('p');
        const modalSubmitBtn = form.querySelector('button[type="submit"]');

        function openSupplierModal(isEdit = false) {
            modal.classList.remove('hidden');
            loadDriveFolders(); // Cargar carpetas din√°micamente

            if (!isEdit) {
                // Modo Alta
                editingSupplierId = null;
                form.reset();
                if (modalTitle) modalTitle.innerText = "Registro de Proveedor";
                if (modalSubtitle) modalSubtitle.innerText = "Alta de Entidad Operativa";
                if (modalSubmitBtn) {
                    modalSubmitBtn.innerText = "Registrar Proveedor";
                    modalSubmitBtn.classList.replace('bg-emerald-600', 'bg-blue-600');
                }
            } else {
                // Modo Edici√≥n
                if (modalTitle) modalTitle.innerText = "Editar Proveedor";
                if (modalSubtitle) modalSubtitle.innerText = "Modificaci√≥n de Datos Maestros";
                if (modalSubmitBtn) {
                    modalSubmitBtn.innerText = "Guardar Cambios";
                    modalSubmitBtn.classList.remove('bg-blue-600');
                    modalSubmitBtn.classList.add('bg-emerald-600');
                }
            }
        }

        function closeSupplierModal() {
            modal.classList.add('hidden');
            form.reset();
            editingSupplierId = null;
            if (modalSubmitBtn) {
                modalSubmitBtn.classList.remove('bg-emerald-600');
                modalSubmitBtn.classList.add('bg-blue-600');
            }
        }

        // Funci√≥n Editar (Llenar form)
        function editSupplier(id) {
            const supplier = currentSuppliers.find(s => s.id === id);
            if (!supplier) return;

            editingSupplierId = id;

            // Rellenar formulario inputs
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                const key = input.name;
                if (supplier[key] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = supplier[key];
                    } else {
                        input.value = supplier[key];
                    }
                }
            });

            openSupplierModal(true);
        }

        // Funci√≥n Eliminar
        async function deleteSupplier(id, nombre) {
            if (!confirm(`¬øEst√° seguro que desea eliminar a "${nombre}" ? `)) return;

            try {
                const { error } = await supabaseClient
                    .from('proveedores')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                renderChatMessage('LAMDA_AI', `üóëÔ∏è Proveedor "${nombre}" eliminado.`);
                loadProveedores(); // Recargar

            } catch (error) {
                console.error("Error delete:", error);
                alert(error.message);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // Recolecci√≥n de datos
            const formData = new FormData(form);
            const supplierData = Object.fromEntries(formData.entries());

            // Fix Checkbox
            supplierData.activo = !!formData.get('activo');

            try {
                let error = null;

                if (editingSupplierId) {
                    // UPDATE
                    const response = await supabaseClient
                        .from('proveedores')
                        .update(supplierData)
                        .eq('id', editingSupplierId);
                    error = response.error;
                } else {
                    // INSERT
                    const response = await supabaseClient
                        .from('proveedores')
                        .insert([supplierData]);
                    error = response.error;
                }

                if (error) throw error;

                // √âxito
                closeSupplierModal();

                const actionVerb = editingSupplierId ? "actualizado" : "registrado";
                renderChatMessage('LAMDA_AI', `‚úÖ Proveedor "${supplierData.nombre}" ${actionVerb} correctamente.`);

                // Recargar Lista
                loadProveedores();

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function (event) {
            if (event.target == modal) closeSupplierModal();
        }


        // L√≥gica de Voz y Chat Mejorada (Push-to-Talk & Historial Persistente)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true; // Permite hablar sin que se corte al silencio
            recognition.interimResults = true; // Ver lo que se escribe en tiempo real

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('mic-active');
                micBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 fill-current"></i>'; // Icono Stop
                lucide.createIcons();
                terminalInput.placeholder = "Escuchando... (Haz clic en el micro para enviar)";
            };

            recognition.onresult = (event) => {
                // Solo mostrar texto, NO enviar autom√°ticamente
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                // Si es final, lo pone en el input, si es interino, tambi√©n (simple overwrite para UX fluida)
                terminalInput.value = transcript;
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('mic-active');
                micBtn.innerHTML = '<i data-lucide="mic" class="w-4 h-4"></i>';
                lucide.createIcons();
                terminalInput.placeholder = "Habla o escribe un comando para la IA...";
                // Opci√≥n: Auto-enviar al terminar? El usuario pidi√≥ control manual.
                // Si el usuario par√≥ manual, toggleVoice manejar√° el env√≠o.
            };
        }

        function toggleVoice() {
            if (!recognition) return alert("Navegador no compatible con voz.");

            if (isRecording) {
                // STOP MANUAL -> ENVIAR
                recognition.stop();
                if (terminalInput.value.trim().length > 0) {
                    sendToAI();
                }
            } else {
                // START MANUAL
                terminalInput.value = '';
                recognition.start();
            }
        }

        function toggleDropdown(dropdownId, containerId) {
            const dropdown = document.getElementById(dropdownId);
            const container = document.getElementById(containerId);

            const allDropdowns = ['tasksDropdown', 'infoDropdown', 'chartsDropdown', 'listsDropdown', 'settingsDropdown'];
            const allContainers = ['tasksMenuContainer', 'infoMenuContainer', 'chartsMenuContainer', 'listsMenuContainer', 'settingsMenuContainer'];

            allDropdowns.forEach((id, index) => {
                if (id !== dropdownId) {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                    const cont = document.getElementById(allContainers[index]);
                    if (cont) cont.classList.remove('menu-open');
                }
            });

            dropdown.classList.toggle('hidden');
            container.classList.toggle('menu-open');
        }

        // Funci√≥n para renderizar mensaje en el chat principal (Persistente)
        function renderChatMessage(role, text) {
            const isUser = role === 'GERENCIA';
            const bgColor = isUser ? 'bg-slate-800/50' : 'bg-blue-600/10 border-blue-500/20';
            const align = isUser ? 'text-right' : 'text-left';
            const icon = isUser ? 'user' : 'bot';

            const html = `
            < div class="mb-6 animate-in fade-in slide-in-from-bottom-2 duration-500" >
                    <div class="flex items-center gap-2 mb-1 ${isUser ? 'justify-end' : 'justify-start'} text-[10px] font-bold uppercase tracking-widest text-slate-500">
                        ${isUser ? `GET /USER/COMMAND` : `RESPONSE /LAMDA/AI`}
                    </div>
                    <div class="${bgColor} p-4 rounded-2xl border border-transparent ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} inline-block max-w-[85%]">
                        <div class="text-sm leading-relaxed whitespace-pre-wrap text-slate-200">${text}</div>
                    </div>
                </div >
            `;

            reportDisplay.insertAdjacentHTML('beforeend', html);
            reportDisplay.scrollTop = reportDisplay.scrollHeight;
        }

        async function taskAction(taskName) {
            // INTERCEPCI√ìN DE COMANDOS DE UI
            if (taskName && taskName.toLowerCase().includes('alta de proveedor')) {
                openSupplierModal();
                renderChatMessage('SISTEMA', 'Abriendo formulario de alta...');
                return;
            }

            aiLoader.classList.remove('hidden');
            const metrics = getMetricsContext();
            const prompt = `Usuario solicita: "${taskName}".Contexto: Proveedores ${metrics.proveedores}, Inversi√≥n ${metrics.inversion}, Deuda ${metrics.deuda}. Genera un informe t√°ctico corto.`;

            // Mostrar comando en chat
            renderChatMessage('GERENCIA', `Ejecutar comando: ${taskName} `);

            // Usar Prompt Dashboard (Modo Dios)
            const sysPrompt = (typeof CONFIG !== 'undefined') ? CONFIG.PROMPT_DASHBOARD : "Eres la IA de gesti√≥n.";
            const response = await callGemini(prompt, sysPrompt);

            aiLoader.classList.add('hidden');
            appendHistory('SISTEMA', `Acci√≥n: ${taskName} `);

            // Mostrar respuesta en chat
            renderChatMessage('LAMDA_AI', response);
        }

        async function callGemini(prompt, sysInstr = null) {
            // Si no se pasa instrucci√≥n espec√≠fica, usar la del Dashboard por defecto
            const finalSysInstr = sysInstr || ((typeof CONFIG !== 'undefined') ? CONFIG.PROMPT_DASHBOARD : "Eres el analista de LAMDA.");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: finalSysInstr }] }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta del n√∫cleo IA.";
                }
                return "Error en la respuesta del sat√©lite IA.";
            } catch (e) { return "Error fatal de conexi√≥n."; }
        }

        async function sendToAI() {
            const text = terminalInput.value.trim();
            if (!text) return;
            terminalInput.value = '';

            aiLoader.classList.remove('hidden');
            appendHistory('GERENCIA', text);

            // Render User Message
            renderChatMessage('GERENCIA', text);

            const response = await callGemini(text);

            aiLoader.classList.add('hidden');
            appendHistory('LAMDA_AI', response);

            // Render AI Response
            renderChatMessage('LAMDA_AI', response);
        }

        function appendHistory(role, text) {
            const div = document.createElement('div');
            div.className = "mb-4";
            div.innerHTML = `<div class="text-[9px] font-bold mb-1 ${role === 'GERENCIA' ? 'text-slate-500' : 'text-blue-500'}">[${new Date().toLocaleTimeString()}] ${role}</div>
                             <div class="p-3 rounded-lg border ${role === 'GERENCIA' ? 'bg-slate-900 border-slate-800 text-slate-400' : 'bg-blue-600/5 border-blue-500/20 text-blue-100'}">${text}</div>`;
            historyContent.appendChild(div);
            historyContent.scrollTop = historyContent.scrollHeight;
        }

        function toggleHistory() { document.getElementById('historyOverlay').classList.toggle('hidden'); }

        function updateTime() {
            const now = new Date();
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            const day = now.getDate();
            const year = now.getFullYear();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('systemTime').innerText = `${day}_${months[now.getMonth()]}_${year}_${h}:${m}`;
        }

        setInterval(updateTime, 1000);
        updateTime();
        terminalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendToAI(); });
        // L√ìGICA DE VISTA PREVIA DE ARCHIVOS (MODAL) - ELIMINADA (Reemplazada por viewerModal)
        // Se mantiene la llamada a 'openFileViewer' definida arriba.
    </script>
</body>

</html>