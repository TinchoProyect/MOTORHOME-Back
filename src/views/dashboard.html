<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAMDA | Terminal de Control de DistribuciÃ³n</title>

    <!-- Scripts de Sistema e Integración -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b 0%, #020617 100%);
            height: 100vh;
            color: #e2e8f0;
            overflow: hidden;
            /* Ocultar contenido hasta verificar sesiÃ³n */
            visibility: hidden;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: #3b82f6;
            color: white;
        }

        .submenu-item {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #3b82f6;
            padding-left: 1.25rem;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.2) 0%, rgba(15, 23, 42, 0.5) 100%);
            border: 1px solid rgba(255, 255, 255, 0.03);
            height: 100%;
        }

        .terminal-font {
            font-family: 'JetBrains Mono', monospace;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 10px;
        }

        .mic-active {
            animation: pulse-red 1.5s infinite;
            color: #ef4444 !important;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .logo-container svg {
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }

        .chevron-icon {
            transition: transform 0.3s ease;
        }

        .menu-open .chevron-icon {
            transform: rotate(180deg);
        }

        /* Ajuste para el menÃº que abre hacia arriba */
        .dropup-content {
            bottom: 100%;
            margin-bottom: 0.5rem;
        }

        /* ESTILOS MODAL PROVEEDORES */
        .modal-blur {
            backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.5);
        }

        .form-input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.1);
            color: #e2e8f0;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .btn-glow {
            transition: all 0.3s ease;
        }

        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="flex h-screen w-screen overflow-hidden">

    <!-- MENÃš LATERAL IZQUIERDO -->
    <aside class="w-64 bg-slate-950/40 border-r border-slate-800 backdrop-blur-xl flex flex-col z-50 shrink-0">
        <div class="p-6 text-slate-400">
            <div class="flex items-center gap-3 mb-10 logo-container">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                    class="text-blue-500">
                    <path d="M12 22C12 22 20 18 20 12V5L12 2L4 5V12C4 18 12 22 12 22Z" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 15V9H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M9 15H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span class="font-bold tracking-tighter text-xl text-white">LAMDA</span>
            </div>

            <nav class="space-y-1">
                <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-4 ml-4">Panel de Control</p>

                <!-- 1. Gestión de listas -->
                <div id="listsMenuContainer">
                    <button onclick="toggleDropdown('listsDropdown', 'listsMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="list-checks" class="w-4 h-4"></i>
                            <span>Gestión de listas</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="listsDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="openSupplierModal()"
                            class="submenu-item text-left py-2 text-[11px] text-emerald-500 hover:text-emerald-400 text-xs font-semibold">+
                            Nuevo Proveedor</button>
                    </div>
                </div>

                <!-- 2. Tareas -->
                <div id="tasksMenuContainer">
                    <button onclick="toggleDropdown('tasksDropdown', 'tasksMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            <span>Tareas</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="tasksDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="taskAction('Generar pedidos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Generar
                            pedidos</button>
                        <button onclick="taskAction('Generar presupuestos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Generar
                            presupuestos</button>
                        <button onclick="taskAction('Solicitar informaciÃ³n a proveedor')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Solicitar
                            informaciÃ³n</button>
                        <button onclick="taskAction('Orden de devoluciÃ³n')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Orden
                            de devoluciÃ³n</button>
                        <button onclick="taskAction('Orden de pago')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Orden
                            de pago</button>
                    </div>
                </div>

                <!-- 3. Info -->
                <div id="infoMenuContainer">
                    <button onclick="toggleDropdown('infoDropdown', 'infoMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                            <span>Info</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="infoDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <!-- Proveedores (Desplegable) -->
                        <div>
                            <button onclick="handleProveedoresClick()"
                                class="w-full submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs flex items-center justify-between group">
                                <span>Proveedores</span>
                                <i data-lucide="chevron-down"
                                    class="w-2.5 h-2.5 opacity-50 group-hover:opacity-100 transition-opacity"></i>
                            </button>
                            <!-- SubmenÃº DinÃ¡mico de Proveedores -->
                            <div id="suppliersSubmenu"
                                class="hidden flex flex-col pl-3 mt-1 space-y-1 border-l border-slate-800/50 mb-2">
                                <!-- Se llena dinÃ¡micamente con JS -->
                                <span class="text-[9px] text-slate-600 px-2 py-1 italic">Cargando...</span>
                            </div>
                        </div>
                        <button onclick="taskAction('Mercadería en tránsito')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Mercadería
                            en tránsito</button>
                        <button onclick="taskAction('Pedidos activos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Pedidos
                            activos</button>
                    </div>
                </div>

                <!-- 4. Gráficos -->
                <div id="chartsMenuContainer">
                    <button onclick="toggleDropdown('chartsDropdown', 'chartsMenuContainer')"
                        class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left">
                        <div class="flex items-center gap-3">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                            <span>Gráficos</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-3 h-3 chevron-icon"></i>
                    </button>
                    <div id="chartsDropdown"
                        class="hidden flex flex-col pl-11 pr-4 py-2 space-y-1 overflow-hidden transition-all duration-300">
                        <button onclick="taskAction('GrÃ¡fico de Inversión')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Inversión</button>
                        <button onclick="taskAction('GrÃ¡fico de Pasivos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Pasivos</button>
                        <button onclick="taskAction('GrÃ¡fico de Activos')"
                            class="submenu-item text-left py-2 text-[11px] text-slate-500 hover:text-blue-400 text-xs">Activos</button>
                    </div>
                </div>
            </nav>
        </div>

        <div class="mt-auto p-6 space-y-4 relative">
            <!-- Desplegable de Configuración (Hacia Arriba) -->
            <div id="settingsMenuContainer" class="relative">
                <!-- SubmenÃº que abre hacia arriba -->
                <div id="settingsDropdown"
                    class="hidden absolute dropup-content w-full flex flex-col pl-11 pr-4 py-2 space-y-1 bg-slate-900/80 backdrop-blur-xl rounded-xl border border-slate-800 overflow-hidden transition-all duration-300 shadow-2xl mb-2">
                    <button onclick="openSupplierModal()"
                        class="submenu-item text-left py-2 text-[11px] text-slate-400 hover:text-blue-400 text-xs font-medium">Alta
                        de proveedor</button>
                    <button id="logoutBtn"
                        class="submenu-item text-left py-2 text-[11px] text-red-400 hover:text-red-300 text-xs font-medium w-full flex items-center gap-2">
                        <i data-lucide="log-out" class="w-3 h-3"></i> Cerrar Sesión
                    </button>
                </div>

                <button onclick="toggleDropdown('settingsDropdown', 'settingsMenuContainer')"
                    class="w-full sidebar-item flex items-center justify-between px-4 py-3 rounded-lg text-sm text-slate-400 text-left transition-all">
                    <div class="flex items-center gap-3">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        <span>Configuración</span>
                    </div>
                    <i data-lucide="chevron-up" class="w-3 h-3 chevron-icon"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- ÃREA DE CONTENIDO PRINCIPAL -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">

        <!-- Header Superior -->
        <header
            class="h-16 flex items-center justify-between px-8 border-b border-slate-800/50 bg-slate-950/20 backdrop-blur-md shrink-0">
            <div>
                <h1 class="text-xs font-mono text-blue-500 tracking-widest uppercase">Sistema Operativo v4.0 // Alta
                    Gerencia</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="systemTime" class="text-xs font-mono text-slate-500">29_ENE_2026_22:40</div>
                <div class="h-4 w-[1px] bg-slate-800"></div>
                <div class="flex items-center gap-2">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-bold border border-slate-700 animate-pulse">
                        ...</div>
                    <span id="userEmail" class="text-xs text-slate-300">Cargando...</span>
                </div>
            </div>
        </header>

        <!-- Rejilla Principal -->
        <main class="flex-1 p-6 flex flex-col gap-4 overflow-hidden">

            <!-- Fila de MÃ©tricas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 h-20 shrink-0">
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="users" class="w-3 h-3"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Proveedores Activos</span>
                    </div>
                    <span class="text-lg font-bold text-slate-200">142</span>
                </div>
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="trending-up" class="w-3 h-3 text-emerald-500"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Inversión Mensual</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-[10px] text-slate-600 font-mono">$</span>
                        <span class="text-lg font-bold text-emerald-400">158.420.000</span>
                    </div>
                </div>
                <div class="metric-card p-3 rounded-lg flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-slate-500 mb-1">
                        <i data-lucide="alert-circle" class="w-3 h-3 text-amber-500"></i>
                        <span class="text-[9px] font-bold uppercase tracking-tighter">Deuda Total</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span class="text-[10px] text-slate-600 font-mono">$</span>
                        <span class="text-lg font-bold text-amber-500">24.150.800</span>
                    </div>
                </div>
            </div>

            <!-- Fila de AnÃ¡lisis -->
            <div class="flex-1 flex flex-col min-h-0 relative">
                <div id="reportDisplay"
                    class="flex-1 terminal-font text-[14px] text-slate-300 overflow-y-auto custom-scrollbar p-6 max-w-4xl mx-auto w-full">
                    <!-- Respuestas de la IA -->
                </div>
            </div>
        </main>

        <!-- TERMINAL DE CHAT -->
        <footer class="p-4 bg-slate-950/80 backdrop-blur-3xl border-t border-blue-500/20 shrink-0">
            <div class="max-w-5xl mx-auto relative flex items-center gap-3">
                <button onclick="toggleHistory()"
                    class="group bg-slate-900 border border-slate-800 p-3 rounded-xl transition-all">
                    <i data-lucide="history" class="w-4 h-4 text-slate-500 group-hover:text-blue-400"></i>
                </button>
                <div class="flex-grow relative flex items-center">
                    <input type="text" id="terminalInput" placeholder="Habla o escribe un comando para la IA..."
                        class="w-full bg-slate-900/50 border border-slate-800 focus:border-blue-500/50 rounded-xl py-3 pl-6 pr-20 outline-none terminal-font text-xs text-white placeholder:text-slate-600 transition-all">
                    <div class="absolute right-2 flex items-center gap-1">
                        <button id="micBtn" onclick="toggleVoice()"
                            class="p-2 text-slate-500 hover:text-white transition-all rounded-lg">
                            <i data-lucide="mic" class="w-4 h-4"></i>
                        </button>
                        <button onclick="sendToAI()"
                            class="p-2 text-blue-500 hover:text-blue-400 transition-all rounded-lg">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Cargador de IA -->
        <div id="aiLoader"
            class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 flex items-center gap-3 bg-blue-600/10 border border-blue-500/30 px-6 py-2 rounded-full backdrop-blur-md z-50">
            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></span>
            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
            <span class="text-[10px] font-mono text-blue-400 uppercase tracking-widest">IA_SINCRO</span>
        </div>

        <!-- Historial -->
        <div id="historyOverlay"
            class="hidden absolute inset-0 z-[60] flex items-center justify-center p-8 bg-black/40 backdrop-blur-2xl">
            <div
                class="glass-panel w-full max-w-4xl h-[60vh] rounded-3xl flex flex-col border border-blue-500/20 overflow-hidden">
                <div
                    class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950/50 text-[10px] font-bold uppercase tracking-widest">
                    <span class="px-2">Registros del Sistema</span>
                    <button onclick="toggleHistory()" class="text-slate-500 hover:text-red-400"><i data-lucide="x"
                            class="w-5 h-5"></i></button>
                </div>
                <div id="historyContent"
                    class="flex-grow overflow-y-auto p-6 space-y-4 custom-scrollbar terminal-font text-[11px]"></div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- COMPONENTE: MODAL ALTA DE PROVEEDOR âœ¨ -->
    <!-- ========================================== -->
    <div id="supplierModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-blur overflow-y-auto">
        <div
            class="glass-panel w-full max-w-2xl rounded-[2.5rem] border border-blue-500/20 shadow-2xl animate-in zoom-in-95 duration-300">

            <!-- Encabezado del Modal -->
            <div class="p-8 border-b border-slate-800/50 flex justify-between items-center bg-slate-950/20">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600/20 p-3 rounded-2xl">
                        <i data-lucide="user-plus" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white tracking-tight leading-none mb-1">Registro de Proveedor
                        </h2>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest font-mono">Alta de Entidad
                            Operativa</p>
                    </div>
                </div>
                <button onclick="closeSupplierModal()"
                    class="text-slate-500 hover:text-white p-2 hover:bg-slate-800 rounded-xl transition-all">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Cuerpo del Formulario -->
            <form id="supplierForm" class="p-8 space-y-6">
                <!-- Fila 1: Identidad -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Empresa / Nombre
                            Comercial</label>
                        <input type="text" name="nombre" placeholder="Ej: Distribuidora Central" required
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CUIT</label>
                        <input type="text" name="cuit" placeholder="XX-XXXXXXXX-X"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Fila 2: ClasificaciÃ³n -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CategorÃ­a Operativa</label>
                    <select name="categoria"
                        class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm appearance-none cursor-pointer">
                        <option value="" class="bg-slate-900">Seleccionar rubro...</option>
                        <option value="Frutos Secos" class="bg-slate-900">Frutos Secos</option>
                        <option value="Enlatados" class="bg-slate-900">Enlatados</option>
                        <option value="Bebidas" class="bg-slate-900">Bebidas</option>
                        <option value="LogÃ­stica" class="bg-slate-900">LogÃ­stica / Transporte</option>
                    </select>
                </div>

                <!-- Fila 3: VinculaciÃ³n Drive -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Carpeta en Drive</label>
                        <div class="relative">
                            <i data-lucide="folder" class="absolute left-4 top-3.5 w-4 h-4 text-slate-600"></i>
                            <select name="drive_folder_id" id="driveFolderSelect"
                                class="w-full form-input bg-slate-900/40 rounded-xl pl-11 pr-4 py-3 text-sm appearance-none cursor-pointer text-slate-300">
                                <option value="">Cargando carpetas...</option>
                            </select>
                            <i data-lucide="chevron-down"
                                class="absolute right-4 top-4 w-3 h-3 text-slate-600 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="space-y-1 flex items-center h-full pt-6">
                        <label
                            class="flex items-center gap-3 cursor-pointer group px-4 py-3 rounded-xl hover:bg-slate-900/50 transition-colors w-full border border-transparent hover:border-slate-800">
                            <input type="checkbox" name="activo"
                                class="w-5 h-5 rounded-md border-slate-600 bg-slate-900/80 text-blue-600 focus:ring-blue-500/50 focus:ring-offset-0 transition-all"
                                checked>
                            <div class="flex flex-col">
                                <span
                                    class="text-xs font-bold text-slate-300 group-hover:text-blue-400 transition-colors">Proveedor
                                    Operativo</span>
                                <span class="text-[9px] text-slate-500">Â¿Habilitar compras y gestiÃ³n?</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Fila 4: Contacto -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Responsable</label>
                        <input type="text" name="contacto_nombre" placeholder="Nombre completo"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Email</label>
                        <input type="email" name="contacto_email" placeholder="ejemplo@mail.com"
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">TelÃ©fono</label>
                        <input type="tel" name="contacto_telefono" placeholder="+54 9..."
                            class="w-full form-input bg-slate-900/40 rounded-xl px-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Fila 4: LogÃ­stica -->
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">DirecciÃ³n de Operaciones</label>
                    <div class="relative">
                        <i data-lucide="map-pin" class="absolute left-4 top-3.5 w-4 h-4 text-slate-600"></i>
                        <input type="text" name="direccion" placeholder="Calle, Altura, Localidad"
                            class="w-full form-input bg-slate-900/40 rounded-xl pl-11 pr-4 py-3 text-sm placeholder:text-slate-700">
                    </div>
                </div>

                <!-- Acciones -->
                <div class="pt-6 flex items-center justify-end gap-4">
                    <button type="button" onclick="closeSupplierModal()"
                        class="px-6 py-3 text-xs font-bold text-slate-500 hover:text-slate-300 transition-all uppercase tracking-widest">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="btn-glow px-8 py-3 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg shadow-blue-900/20">
                        Registrar Proveedor
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Integración de LÃ³gica y Seguridad -->
    <script>
        lucide.createIcons();

        // 1. Configuración de Seguridad y Backend
        const sbUrl = (typeof CONFIG !== 'undefined') ? CONFIG.SUPABASE_URL : "";
        const sbKey = (typeof CONFIG !== 'undefined') ? CONFIG.SUPABASE_ANON_KEY : "";
        // Usar API Key real de config.js para la IA
        const apiKey = (typeof CONFIG !== 'undefined') ? CONFIG.GEMINI_API_KEY : "";

        // Renombrado a supabaseClient para evitar conflicto con window.supabase
        let supabaseClient = null;

        // 2. Guardia de Sesión (ProtecciÃ³n de Ruta)
        async function initSystem() {
            if (!sbUrl || !sbKey) {
                console.error("CRITICAL: Faltan credenciales del sistema.");
                window.location.href = 'acceso.html'; // Expulsión preventiva
                return;
            }

            // Inicializar Cliente Supabase
            supabaseClient = window.supabase.createClient(sbUrl, sbKey);

            // Verificar Sesión Activa
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session) {
                // Si no hay sesiÃ³n, REDIRIGIR AL LOGIN
                console.warn("⚠️ Acceso no autorizado. Redirigiendo a puerta de enlace...");
                window.location.href = 'acceso.html';
            } else {
                // Sesión VÃ¡lida: Mostrar Interfaz y Cargar Datos
                document.body.style.visibility = 'visible';
                console.log("✅ Sistema Operativo. Usuario:", session.user.email);

                // Actualizar UI con datos de usuario
                document.getElementById('userEmail').innerText = session.user.email;
                document.getElementById('userAvatar').innerText = session.user.email.substring(0, 2).toUpperCase();
                document.getElementById('userAvatar').classList.remove('animate-pulse'); // Stop loading animation

                // Cargar Sidebar de Proveedores (Lazy Load inicial)
                loadSuppliersSidebar();
            }

            // Listener de Auth State Change (para logout global)
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') window.location.href = 'acceso.html';
            });
        }

        // Ejecutar Inmediatamente
        initSystem();

        // 3. LÃ³gica del Chasis (Interfaz Original del Chapista)
        const terminalInput = document.getElementById('terminalInput');
        const aiLoader = document.getElementById('aiLoader');
        const historyContent = document.getElementById('historyContent');
        const micBtn = document.getElementById('micBtn');
        const reportDisplay = document.getElementById('reportDisplay');
        const logoutBtn = document.getElementById('logoutBtn');

        // Logout
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'acceso.html';
            });
        }

        // Placeholder for real metrics, assuming it will be fetched or calculated
        let realMetrics = {
            proveedoresCount: 142, // Example initial value
            inversion: "$158.420.000 Pesos",
            deuda: "$24.150.800 Pesos"
        };

        // Estado Global de Proveedores
        let currentSuppliers = [];
        let editingSupplierId = null;

        // --- EXPLORADOR DE ARCHIVOS (DRIVE) ---
        async function exploreSupplierFiles(folderId, providerId) {
            if (!folderId) return;

            // Mostrar estado de carga en el panel central
            reportDisplay.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-blue-400 animate-in fade-in duration-300">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"></div>
                        <i data-lucide="hard-drive" class="absolute inset-0 m-auto w-6 h-6 text-white animate-pulse"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1">Conectando con Drive</h3>
                    <p class="text-xs text-slate-500 font-mono">ID: ${folderId}</p>
                </div>
            `;
            lucide.createIcons();

            try {
                // Fetch archivos usando la URL base (backendBaseUrl ya definido anteriormente)
                const url = backendBaseUrl ? `${backendBaseUrl}/api/files/list?folderId=${folderId}` : `/api/files/list?folderId=${folderId}`;

                const res = await fetch(url);
                const data = await res.json();

                if (!data.success) throw new Error(data.error || "Error desconocido");

                renderFileGrid(data.files, folderId, providerId);

            } catch (error) {
                console.error("Error explorador:", error);
                reportDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400">
                        <i data-lucide="alert-triangle" class="w-12 h-12 mb-4 opacity-80"></i>
                        <p class="text-lg font-bold">Error de Conexión</p>
                        <p class="text-sm text-slate-500 max-w-md text-center mt-2">${error.message}</p>
                        <button onclick="showSuppliersList()" class="mt-6 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs transition-colors">Volver</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderFileGrid(files, folderId, providerId) {
            // Helpers de Iconos
            const getIcon = (mime) => {
                if (mime.includes('folder')) return 'folder';
                if (mime.includes('image')) return 'image';
                if (mime.includes('pdf')) return 'file-text';
                if (mime.includes('spreadsheet') || mime.includes('excel') || mime.includes('csv')) return 'table';
                return 'file';
            };

            const getColor = (mime) => {
                if (mime.includes('folder')) return 'text-yellow-500';
                if (mime.includes('image')) return 'text-purple-400';
                if (mime.includes('pdf')) return 'text-red-400';
                if (mime.includes('spreadsheet')) return 'text-emerald-400';
                return 'text-slate-400';
            };

            // Header con NavegaciÃ³n
            let html = `
                <div class="h-full flex flex-col animate-in slide-in-from-bottom-4 duration-500 p-2">
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-800">
                        <div class="flex items-center gap-3">
                            <button onclick="showSuppliersList()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                    <i data-lucide="folder-open" class="w-5 h-5 text-blue-500"></i>
                                    Archivos del Proveedor
                                </h2>
                                <span class="text-[10px] text-slate-500 font-mono tracking-wider">INDEXANDO ${files.length} ELEMENTOS</span>
                            </div>
                        </div>
                        <a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" class="px-3 py-1.5 bg-slate-800 hover:bg-blue-600/20 text-slate-300 hover:text-blue-400 border border-slate-700 rounded-lg text-xs font-medium transition-all flex items-center gap-2">
                            Drive Exte&shy;rno <i data-lucide="external-link" class="w-3 h-3"></i>
                        </a>
                    </div>
            `;

            // Grid de Contenido
            if (files.length === 0) {
                html += `
                    <div class="flex-grow flex flex-col items-center justify-center text-slate-600">
                        <i data-lucide="folder-open" class="w-16 h-16 mb-4 opacity-20"></i>
                        <p class="text-sm">Carpeta vacÃ­a</p>
                    </div>
                `;
            } else {
                html += `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto custom-scrollbar pr-2 pb-10">`;

                files.forEach(file => {
                    const iconName = getIcon(file.mimeType);
                    const colorClass = getColor(file.mimeType);

                    html += `
                        <div class="group relative bg-slate-900/40 hover:bg-slate-900/80 border border-slate-800 hover:border-blue-500/30 rounded-xl p-4 flex flex-col items-center gap-3 transition-all hover:-translate-y-1 hover:shadow-xl hover:shadow-blue-900/10">
                            <a href="${file.webViewLink}" target="_blank" class="flex flex-col items-center gap-3 w-full">
                            <div class="w-12 h-12 bg-slate-950 rounded-lg flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="${iconName}" class="w-6 h-6 ${colorClass}"></i>
                            </div>
                            <div class="text-center w-full">
                                <h4 class="text-xs font-medium text-slate-300 group-hover:text-blue-200 truncate w-full" title="${file.name}">${file.name}</h4>
                                <span class="text-[9px] text-slate-600 uppercase mt-1 block group-hover:text-slate-500 transition-colors">Abrir</span>
                            </div>
                        </a>
                        <button onclick="startExtraction('${file.id}', '${file.name}', '${providerId}', '${file.webViewLink}')" class="w-full mt-2 py-2 bg-blue-600/20 hover:bg-blue-600/80 text-blue-400 hover:text-white rounded-lg text-[10px] font-bold uppercase tracking-widest border border-blue-500/30 transition-all flex items-center justify-center gap-2">
                             <i data-lucide="zap" class="w-3 h-3"></i> Extraer
                        </button>
                    </div>
                    `;
                });

                html += `</div>`;
            }

            html += `</div>`;
            reportDisplay.innerHTML = html;
            lucide.createIcons();
        }

        // Alias para compatibilidad con instrucciones de usuario
        async function showSuppliersList() {
            await loadProveedores();
        }

        // --- LÃ“GICA DE NAVEGACIÃ“N DINÃMICA DE PROVEEDORES ---

        function handleProveedoresClick() {
            const submenu = document.getElementById('suppliersSubmenu');
            // Toggle visibilidad
            submenu.classList.toggle('hidden');

            // Cargar lista si estÃ¡ vacÃ­o (lazy load)
            if (!submenu.classList.contains('hidden')) { // Si se abre
                loadSuppliersSidebar();
            }
            // Mostrar lista general en el centro
            showSuppliersList();
        }

        async function loadSuppliersSidebar() {
            const container = document.getElementById('suppliersSubmenu');

            const { data, error } = await supabaseClient
                .from('proveedores')
                .select('id, nombre')
                .eq('activo', true) // Solo activos en sidebar? O todos? Usuario dijo "todos los proveedores".
                .order('nombre', { ascending: true });

            if (error) {
                console.error("Error sidebar:", error);
                container.innerHTML = '<span class="text-[9px] text-red-400 px-2">Error</span>';
                return;
            }

            container.innerHTML = ''; // Limpiar

            if (data.length === 0) {
                container.innerHTML = '<span class="text-[9px] text-slate-600 px-2 italic">Sin proveedores</span>';
                return;
            }

            data.forEach(p => {
                const btn = document.createElement('button');
                btn.onclick = (e) => {
                    e.stopPropagation(); // Evitar cerrar menÃº si fuera necesario
                    showSingleSupplier(p.id);
                };
                btn.className = "text-left py-1.5 px-2 text-[10px] text-slate-500 hover:text-blue-400 hover:bg-slate-900/50 rounded transition-colors whitespace-nowrap overflow-hidden text-ellipsis";
                btn.innerText = p.nombre;
                container.appendChild(btn);
            });
        }

        async function showSingleSupplier(id) {
            // Buscar datos completos (OptimizaciÃ³n: buscar en cache local si existe, o fetch)
            let supplier = currentSuppliers.find(s => s.id === id);

            if (!supplier) {
                // Fetch on demand si no estÃ¡ en cache
                reportDisplay.innerHTML = `<div class="flex items-center justify-center h-full text-blue-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-2"></i> Cargando ficha...</div>`;
                lucide.createIcons();
                const { data } = await supabaseClient.from('proveedores').select('*').eq('id', id).single();
                supplier = data;
            }

            if (!supplier) {
                reportDisplay.innerHTML = '<div class="text-red-500">Proveedor no encontrado</div>';
                return;
            }

            // Renderizar Ficha TÃ©cnica
            reportDisplay.innerHTML = `
                <div class="h-full flex flex-col animate-in fade-in zoom-in-95 duration-300 p-2">
                    <!-- Header Ficha -->
                    <div class="flex justify-between items-start mb-8 border-b border-slate-800 pb-6">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-3xl font-bold text-white tracking-tight">${supplier.nombre}</h2>
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-widest">${supplier.categoria || 'GENERAL'}</span>
                            </div>
                            <div class="flex items-center gap-4 text-slate-500 text-xs font-mono">
                                <span>CUIT: <span class="text-slate-400">${supplier.cuit || 'N/A'}</span></span>
                                <span>â€¢</span>
                                <span>ID: ${supplier.id.substring(0, 8)}</span>
                            </div>
                        </div>
                        <button onclick="editSupplier('${supplier.id}')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700/50 rounded-lg text-xs font-bold transition-all flex items-center gap-2 group">
                            <i data-lucide="pencil" class="w-3 h-3 group-hover:text-white transition-colors"></i> EDITAR
                        </button>
                    </div>

                    <!-- Grid de InformaciÃ³n -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Columna 1: Operativa e Infra -->
                        <div class="space-y-6">
                            <!-- Estado -->
                            <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50 relative overflow-hidden group">
                                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-colors"></div>
                                <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <i data-lucide="activity" class="w-3 h-3"></i> Estado Operativo
                                </h3>
                                <div class="flex items-center gap-3">
                                    <div class="w-3 h-3 rounded-full ${supplier.activo ? 'bg-emerald-500 shadow-[0_0_12px_rgba(16,185,129,0.4)]' : 'bg-red-500 shadow-[0_0_12px_rgba(239,68,68,0.4)]'}"></div>
                                    <span class="text-sm font-medium ${supplier.activo ? 'text-emerald-400' : 'text-red-400'}">
                                        ${supplier.activo ? 'ACTIVO Y VALIDADO' : 'SUSPENDIDO / INACTIVO'}
                                    </span>
                                </div>
                            </div>

                            <!-- Drive -->
                            <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50">
                                <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                    <i data-lucide="hard-drive" class="w-3 h-3"></i> Digital Assets
                                </h3>
                                ${supplier.drive_folder_id
                    ? `<div onclick="exploreSupplierFiles('${supplier.drive_folder_id}', '${supplier.id}')" class="flex items-center justify-between p-3 bg-slate-950/50 rounded-lg border border-slate-800 group hover:border-blue-500/30 transition-colors cursor-pointer">
                                        <div class="flex items-center gap-3">
                                            <div class="p-2 bg-slate-900 rounded-md text-blue-500">
                                                <i data-lucide="folder" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-xs font-bold text-slate-300 group-hover:text-white transition-colors">Carpeta Vinculada</span>
                                                <span class="text-[9px] text-slate-600 font-mono">${supplier.drive_folder_id}</span>
                                            </div>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-600 group-hover:text-blue-400 transition-colors"></i>
                                       </div>`
                    : `<div class="text-xs text-slate-600 italic py-2">Sin carpeta vinculada</div>`
                }
                            </div>
                        </div>

                        <!-- Columna 2: Contacto y Datos -->
                        <div class="p-6 bg-slate-900/30 rounded-xl border border-slate-800/50 h-full">
                            <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i data-lucide="user-check" class="w-3 h-3"></i> Contacto y LogÃ­stica
                            </h3>
                            
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="block text-[9px] text-slate-500 uppercase mb-1">Responsable</span>
                                        <span class="text-sm text-slate-300 font-medium border-b border-transparent hover:border-blue-500/50 transition-colors inline-block pb-0.5">
                                            ${supplier.contacto_nombre || '-'}
                                        </span>
                                    </div>
                                    <div>
                                        <span class="block text-[9px] text-slate-500 uppercase mb-1">TelÃ©fono</span>
                                        <span class="text-sm text-slate-300 font-mono">${supplier.contacto_telefono || '-'}</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <span class="block text-[9px] text-slate-500 uppercase mb-1">Email Corporativo</span>
                                    <a href="mailto:${supplier.contacto_email}" class="flex items-center gap-2 text-sm text-blue-400/80 hover:text-blue-400 transition-colors">
                                        <i data-lucide="mail" class="w-3 h-3"></i>
                                        ${supplier.contacto_email || '-'}
                                    </a>
                                </div>

                                <div class="pt-4 border-t border-slate-800/50">
                                    <span class="block text-[9px] text-slate-500 uppercase mb-1">DirecciÃ³n Operativa</span>
                                    <div class="flex items-start gap-2 text-slate-400 text-xs">
                                        <i data-lucide="map-pin" class="w-3 h-3 mt-0.5 shrink-0 text-slate-600"></i>
                                        ${supplier.direccion || 'Sin direcciÃ³n registrada'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }


        // LÃ³gica para cargar proveedores (asumiendo que se obtienen de Supabase)
        async function loadProveedores() {
            reportDisplay.innerHTML = `<div class="flex items-center justify-center h-full text-blue-400">
                                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin mr-2"></i>
                                        Cargando proveedores...
                                    </div>`;
            lucide.createIcons();

            const { data, error } = await supabaseClient
                .from('proveedores')
                .select('*')
                .order('nombre', { ascending: true }); // Orden alfabÃ©tico

            if (error) {
                console.error("Error al cargar proveedores:", error);
                reportDisplay.innerHTML = `<div class="text-red-500">Error al cargar proveedores: ${error.message}</div>`;
                return;
            }

            // Actualizar estado local
            currentSuppliers = data;

            // Actualizar mÃ©tricas reales
            realMetrics.proveedoresCount = data.length;

            if (data.length === 0) {
                reportDisplay.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-500">
                        <i data-lucide="inbox" class="w-12 h-12 mb-4 opacity-50"></i>
                        <p class="text-sm">No hay proveedores registrados.</p>
                        <button onclick="openSupplierModal()" class="mt-4 px-4 py-2 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 rounded-lg text-xs transition-colors border border-blue-500/30">
                            + Dar de Alta
                        </button>
                    </div>
                `;
            } else {
                // Renderizar la tabla de proveedores
                let tableHtml = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">Listado de Proveedores</h3>
                        <span class="text-xs text-slate-500 font-mono">${data.length} REGISTROS</span>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar rounded-xl border border-slate-800">
                        <table class="min-w-full divide-y divide-slate-800 bg-slate-900/40">
                            <thead class="bg-slate-950/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">Empresa</th>
                                    <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden md:table-cell">CUIT</th>
                                    <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest">CategorÃ­a</th>
                                    <th class="px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest hidden md:table-cell">Contacto</th>
                                    <th class="px-4 py-3 text-right text-[10px] font-bold text-slate-500 uppercase tracking-widest">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800/50">
                `;
                data.forEach(supplier => {
                    tableHtml += `
                        <tr class="hover:bg-blue-600/5 transition-colors group">
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="text-xs font-bold text-white">${supplier.nombre}</div>
                                <div class="text-[10px] text-slate-500 md:hidden">${supplier.cuit || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-xs text-slate-400 font-mono hidden md:table-cell">${supplier.cuit || '-'}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-slate-800 text-slate-300 border border-slate-700 uppercase">
                                    ${supplier.categoria || 'General'}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap hidden md:table-cell">
                                <div class="text-xs text-slate-300">${supplier.contacto_nombre || '-'}</div>
                                <div class="text-[10px] text-slate-500">${supplier.contacto_email || ''}</div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                <div class="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                    <button onclick="editSupplier('${supplier.id}')" class="p-1.5 hover:bg-blue-500/20 text-blue-400 rounded-lg transition-colors border border-transparent hover:border-blue-500/30" title="Editar">
                                        <i data-lucide="pencil" class="w-3 h-3"></i>
                                    </button>
                                    <button onclick="deleteSupplier('${supplier.id}', '${supplier.nombre}')" class="p-1.5 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors border border-transparent hover:border-red-500/30" title="Eliminar">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                reportDisplay.innerHTML = tableHtml;
            }
            lucide.createIcons();
            // Update realMetrics with actual count
            realMetrics.proveedoresCount = data.length;
        }

        // LÃ³gica de MÃ©tricas Contextuales Actualizada (ZERO HALLUCINATIONS)
        const getMetricsContext = () => {
            return {
                proveedores: `${realMetrics.proveedoresCount} registrados en base de datos.`,
                inversion: realMetrics.inversion,
                deuda: realMetrics.deuda
            };
        };

        // LÃ“GICA DE VINCULACIÃ“N DRIVE
        let driveFoldersCache = null;
        const backendBaseUrl = (typeof CONFIG !== 'undefined' && CONFIG.BACKEND_URL) ? CONFIG.BACKEND_URL : "";

        async function loadDriveFolders() {
            const select = document.getElementById('driveFolderSelect');
            // Si ya hay opciones (ademÃ¡s del placeholder), no recargar agresivamente, salvo que sea la primera vez real
            if (driveFoldersCache && select.children.length > 1) return;

            try {
                // Fetch using absolute path (if config exists) or relative (fallback)
                const url = backendBaseUrl ? `${backendBaseUrl}/api/files/list?type=folders` : '/api/files/list?type=folders';

                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    driveFoldersCache = data.files;
                    populateSelect(select, driveFoldersCache);
                } else {
                    select.innerHTML = '<option value="">Error cargando carpetas</option>';
                }
            } catch (e) {
                console.error("Error loading folders:", e);
                select.innerHTML = '<option value="">Error de conexiÃ³n con Drive</option>';
            }
        }

        function populateSelect(select, files) {
            const currentVal = select.value;
            select.innerHTML = '<option value="">Sin vinculaciÃ³n (Seleccionar carpeta)</option>';
            files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.innerText = f.name;
                select.appendChild(opt);
            });
            // Restaurar valor si existÃ­a (Ãºtil en ediciones rÃ¡pidas)
            if (currentVal) select.value = currentVal;
        }

        // LÃ“GICA MODAL PROVEEDORES + SUPABASE INTEGRATION
        const modal = document.getElementById('supplierModal');
        const form = document.getElementById('supplierForm');

        const modalTitle = modal.querySelector('h2');
        const modalSubtitle = modal.querySelector('p');
        const modalSubmitBtn = form.querySelector('button[type="submit"]');

        function openSupplierModal(isEdit = false) {
            modal.classList.remove('hidden');
            loadDriveFolders(); // Cargar carpetas dinÃ¡micamente

            if (!isEdit) {
                // Modo Alta
                editingSupplierId = null;
                form.reset();
                if (modalTitle) modalTitle.innerText = "Registro de Proveedor";
                if (modalSubtitle) modalSubtitle.innerText = "Alta de Entidad Operativa";
                if (modalSubmitBtn) {
                    modalSubmitBtn.innerText = "Registrar Proveedor";
                    modalSubmitBtn.classList.replace('bg-emerald-600', 'bg-blue-600');
                }
            } else {
                // Modo EdiciÃ³n
                if (modalTitle) modalTitle.innerText = "Editar Proveedor";
                if (modalSubtitle) modalSubtitle.innerText = "ModificaciÃ³n de Datos Maestros";
                if (modalSubmitBtn) {
                    modalSubmitBtn.innerText = "Guardar Cambios";
                    modalSubmitBtn.classList.remove('bg-blue-600');
                    modalSubmitBtn.classList.add('bg-emerald-600');
                }
            }
        }

        function closeSupplierModal() {
            modal.classList.add('hidden');
            form.reset();
            editingSupplierId = null;
            if (modalSubmitBtn) {
                modalSubmitBtn.classList.remove('bg-emerald-600');
                modalSubmitBtn.classList.add('bg-blue-600');
            }
        }

        // FunciÃ³n Editar (Llenar form)
        function editSupplier(id) {
            const supplier = currentSuppliers.find(s => s.id === id);
            if (!supplier) return;

            editingSupplierId = id;

            // Rellenar formulario inputs
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                const key = input.name;
                if (supplier[key] !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = supplier[key];
                    } else {
                        input.value = supplier[key];
                    }
                }
            });

            openSupplierModal(true);
        }

        // FunciÃ³n Eliminar
        async function deleteSupplier(id, nombre) {
            if (!confirm(`Â¿EstÃ¡ seguro que desea eliminar a "${nombre}"?`)) return;

            try {
                const { error } = await supabaseClient
                    .from('proveedores')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                renderChatMessage('LAMDA_AI', `ðŸ—‘ï¸ Proveedor "${nombre}" eliminado.`);
                loadProveedores(); // Recargar

            } catch (error) {
                console.error("Error delete:", error);
                alert(error.message);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
            btn.disabled = true;
            lucide.createIcons();

            // RecolecciÃ³n de datos
            const formData = new FormData(form);
            const supplierData = Object.fromEntries(formData.entries());

            // Fix Checkbox
            supplierData.activo = !!formData.get('activo');

            try {
                let error = null;

                if (editingSupplierId) {
                    // UPDATE
                    const response = await supabaseClient
                        .from('proveedores')
                        .update(supplierData)
                        .eq('id', editingSupplierId);
                    error = response.error;
                } else {
                    // INSERT
                    const response = await supabaseClient
                        .from('proveedores')
                        .insert([supplierData]);
                    error = response.error;
                }

                if (error) throw error;

                // Ã‰xito
                closeSupplierModal();

                const actionVerb = editingSupplierId ? "actualizado" : "registrado";
                renderChatMessage('LAMDA_AI', `✅ Proveedor "${supplierData.nombre}" ${actionVerb} correctamente.`);

                // Recargar Lista
                loadProveedores();

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function (event) {
            if (event.target == modal) closeSupplierModal();
        }


        // LÃ³gica de Voz y Chat Mejorada (Push-to-Talk & Historial Persistente)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true; // Permite hablar sin que se corte al silencio
            recognition.interimResults = true; // Ver lo que se escribe en tiempo real

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('mic-active');
                micBtn.innerHTML = '<i data-lucide="square" class="w-4 h-4 fill-current"></i>'; // Icono Stop
                lucide.createIcons();
                terminalInput.placeholder = "Escuchando... (Haz clic en el micro para enviar)";
            };

            recognition.onresult = (event) => {
                // Solo mostrar texto, NO enviar automÃ¡ticamente
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                // Si es final, lo pone en el input, si es interino, tambiÃ©n (simple overwrite para UX fluida)
                terminalInput.value = transcript;
            };

            recognition.onend = () => {
                isRecording = false;
                micBtn.classList.remove('mic-active');
                micBtn.innerHTML = '<i data-lucide="mic" class="w-4 h-4"></i>';
                lucide.createIcons();
                terminalInput.placeholder = "Habla o escribe un comando para la IA...";
                // OpciÃ³n: Auto-enviar al terminar? El usuario pidiÃ³ control manual.
                // Si el usuario parÃ³ manual, toggleVoice manejarÃ¡ el envÃ­o.
            };
        }

        function toggleVoice() {
            if (!recognition) return alert("Navegador no compatible con voz.");

            if (isRecording) {
                // STOP MANUAL -> ENVIAR
                recognition.stop();
                if (terminalInput.value.trim().length > 0) {
                    sendToAI();
                }
            } else {
                // START MANUAL
                terminalInput.value = '';
                recognition.start();
            }
        }

        function toggleDropdown(dropdownId, containerId) {
            const dropdown = document.getElementById(dropdownId);
            const container = document.getElementById(containerId);

            const allDropdowns = ['tasksDropdown', 'infoDropdown', 'chartsDropdown', 'listsDropdown', 'settingsDropdown'];
            const allContainers = ['tasksMenuContainer', 'infoMenuContainer', 'chartsMenuContainer', 'listsMenuContainer', 'settingsMenuContainer'];

            allDropdowns.forEach((id, index) => {
                if (id !== dropdownId) {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                    const cont = document.getElementById(allContainers[index]);
                    if (cont) cont.classList.remove('menu-open');
                }
            });

            dropdown.classList.toggle('hidden');
            container.classList.toggle('menu-open');
        }

        // FunciÃ³n para renderizar mensaje en el chat principal (Persistente)
        function renderChatMessage(role, text) {
            const isUser = role === 'GERENCIA';
            const bgColor = isUser ? 'bg-slate-800/50' : 'bg-blue-600/10 border-blue-500/20';
            const align = isUser ? 'text-right' : 'text-left';
            const icon = isUser ? 'user' : 'bot';

            const html = `
                <div class="mb-6 animate-in fade-in slide-in-from-bottom-2 duration-500">
                    <div class="flex items-center gap-2 mb-1 ${isUser ? 'justify-end' : 'justify-start'} text-[10px] font-bold uppercase tracking-widest text-slate-500">
                        ${isUser ? `GET /USER/COMMAND` : `RESPONSE /LAMDA/AI`}
                    </div>
                    <div class="${bgColor} p-4 rounded-2xl border border-transparent ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} inline-block max-w-[85%]">
                        <div class="text-sm leading-relaxed whitespace-pre-wrap text-slate-200">${text}</div>
                    </div>
                </div>
            `;

            reportDisplay.insertAdjacentHTML('beforeend', html);
            reportDisplay.scrollTop = reportDisplay.scrollHeight;
        }

        async function taskAction(taskName) {
            // INTERCEPCIÃ“N DE COMANDOS DE UI
            if (taskName && taskName.toLowerCase().includes('alta de proveedor')) {
                openSupplierModal();
                renderChatMessage('SISTEMA', 'Abriendo formulario de alta...');
                return;
            }

            aiLoader.classList.remove('hidden');
            const metrics = getMetricsContext();
            const prompt = `Usuario solicita: "${taskName}". Contexto: Proveedores ${metrics.proveedores}, Inversión ${metrics.inversion}, Deuda ${metrics.deuda}. Genera un informe tÃ¡ctico corto.`;

            // Mostrar comando en chat
            renderChatMessage('GERENCIA', `Ejecutar comando: ${taskName}`);

            // Usar Prompt Dashboard (Modo Dios)
            const sysPrompt = (typeof CONFIG !== 'undefined') ? CONFIG.PROMPT_DASHBOARD : "Eres la IA de gestiÃ³n.";
            const response = await callGemini(prompt, sysPrompt);

            aiLoader.classList.add('hidden');
            appendHistory('SISTEMA', `AcciÃ³n: ${taskName}`);

            // Mostrar respuesta en chat
            renderChatMessage('LAMDA_AI', response);
        }

        async function callGemini(prompt, sysInstr = null) {
            // Si no se pasa instrucciÃ³n especÃ­fica, usar la del Dashboard por defecto
            const finalSysInstr = sysInstr || ((typeof CONFIG !== 'undefined') ? CONFIG.PROMPT_DASHBOARD : "Eres el analista de LAMDA.");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: finalSysInstr }] }
            };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta del nÃºcleo IA.";
                }
                return "Error en la respuesta del satÃ©lite IA.";
            } catch (e) { return "Error fatal de conexiÃ³n."; }
        }

        async function sendToAI() {
            const text = terminalInput.value.trim();
            if (!text) return;
            terminalInput.value = '';

            aiLoader.classList.remove('hidden');
            appendHistory('GERENCIA', text);

            // Render User Message
            renderChatMessage('GERENCIA', text);

            const response = await callGemini(text);

            aiLoader.classList.add('hidden');
            appendHistory('LAMDA_AI', response);

            // Render AI Response
            renderChatMessage('LAMDA_AI', response);
        }

        function appendHistory(role, text) {
            const div = document.createElement('div');
            div.className = "mb-4";
            div.innerHTML = `<div class="text-[9px] font-bold mb-1 ${role === 'GERENCIA' ? 'text-slate-500' : 'text-blue-500'}">[${new Date().toLocaleTimeString()}] ${role}</div>
                             <div class="p-3 rounded-lg border ${role === 'GERENCIA' ? 'bg-slate-900 border-slate-800 text-slate-400' : 'bg-blue-600/5 border-blue-500/20 text-blue-100'}">${text}</div>`;
            historyContent.appendChild(div);
            historyContent.scrollTop = historyContent.scrollHeight;
        }

        function toggleHistory() { document.getElementById('historyOverlay').classList.toggle('hidden'); }

        function updateTime() {
            const now = new Date();
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            const day = now.getDate();
            const year = now.getFullYear();
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('systemTime').innerText = `${day}_${months[now.getMonth()]}_${year}_${h}:${m}`;
        }

        // Global Logic
        let dictionary = []; // Cache local

        async function fetchDictionary() {
            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/api/dictionary`);
                if (res.ok) dictionary = await res.json();
            } catch (e) { console.error("Error loading dictionary", e); }
        }

        // Initialize Dictionary
        fetchDictionary();

        setInterval(updateTime, 1000);
        updateTime();
        terminalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendToAI(); });

        // --- LOGICA DE EXTRACCION (Motor v6) ---
        // Variables Globales de Mapeo
        let currentMapping = {};
        let currentHeaders = [];
        let currentFileCtx = {};
        let currentHeaderIndex = 0;

        async function startExtraction(fileId, fileName, providerId, webViewLink, headerIndexOverride = null) {
            if (headerIndexOverride !== null) {
                currentHeaderIndex = headerIndexOverride;
            } else {
                currentHeaderIndex = 0;
            }
            const reportDisplay = document.getElementById('reportDisplay');
            reportDisplay.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-4 animate-pulse">
                    <i data-lucide="brain-circuit" class="w-12 h-12 text-blue-500"></i>
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-white">Analizando Estructura...</h3>
                        <p class="text-sm">El motor de IA estÃ¡ leyendo el archivo directo.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();

            try {
                // LLAMADA AL BACKEND
                const res = await fetch(`${CONFIG.BACKEND_URL}/api/files/extraction/process`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId, fileName, providerId, headerIndex: currentHeaderIndex })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || "Error en el proceso de extracciÃ³n");
                }

                // 3. Renderizar Resultados (Active Mapping Mode)
                renderExtractionResults(data, fileName, webViewLink, fileId, providerId);

            } catch (error) {
                console.error("Extraction Error:", error);
                reportDisplay.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-red-400 gap-2 p-8 text-center">
                        <i data-lucide="alert-triangle" class="w-10 h-10"></i>
                        <h3 class="text-lg font-bold">Error en ExtracciÃ³n</h3>
                        <p class="text-xs bg-slate-900/50 p-2 rounded border border-red-500/20 font-mono">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderExtractionResults(result, fileName, webViewLink, fileId, providerId) {
            // Guardar Contexto Global
            currentFileCtx = { fileId, providerId, fileName, webViewLink };
            currentHeaders = result.data.headers_detected || [];
            currentMapping = {}; // Reset de mapeo

            const isDiscovery = result.mode === 'DISCOVERY';
            const headers = currentHeaders;
            const rows = result.data.data_sample || [];

            // Generar Filas de Tabla
            let tableRowsHtml = '';
            rows.forEach(row => {
                tableRowsHtml += `<tr class="border-b border-slate-800/50 hover:bg-slate-800/20 transition-colors">`;
                headers.forEach(h => {
                    const cellVal = row[h] || '-';
                    tableRowsHtml += `<td class="px-3 py-2 text-xs text-slate-300 whitespace-nowrap">${cellVal}</td>`;
                });
                tableRowsHtml += '</tr>';
            });

            // Crear HTML Base
            let html = `
                <div class="h-full flex flex-col p-4 animate-in slide-in-from-right duration-500 overflow-hidden">
                    <!-- Header Reporte -->
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800 shrink-0">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <h2 class="text-xl font-bold text-white">Informe de Conocimiento</h2>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${isDiscovery ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'} uppercase">
                                    ${isDiscovery ? 'MODO ARQUEÓLOGO' : 'MODO OPERARIO'}
                                </span>
                                <!-- EXCAVATION TOOL -->
                                <div class="flex items-center gap-2 ml-4 bg-slate-900 border border-slate-700 rounded px-2 py-0.5">
                                    <span class="text-[10px] text-slate-400 uppercase font-bold">Fila Encabezado:</span>
                                    <input type="number" id="headerIndexInput" value="${currentHeaderIndex}" min="0" class="w-10 bg-slate-800 text-white text-xs text-center rounded border border-slate-700 focus:border-blue-500 outline-none p-0.5">
                                    <button onclick="refreshWithNewHeader()" class="p-0.5 hover:bg-slate-700 rounded text-blue-400" title="Actualizar Vista">
                                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 font-mono">Archivo: ${fileName}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="confirmFinalMapping()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-widest rounded-lg shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Confirmar Inteligencia
                            </button>
                             <button onclick="loadProveedores()" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded-lg transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Layout Side-by-Side -->
                    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-4 overflow-hidden h-full pb-4">
                        
                        <!-- Panel Izquierdo: Documento -->
                        <div class="h-full bg-slate-900 rounded-xl border border-slate-800 overflow-hidden flex flex-col">
                            <div class="bg-slate-950 px-3 py-2 border-b border-slate-800 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="eye" class="w-3 h-3"></i> Documento Original</span>
                                <a href="${webViewLink}" target="_blank" class="text-[10px] text-blue-400 hover:underline">Abrir en PestaÃ±a</a>
                            </div>
                            <iframe src="${webViewLink ? webViewLink.replace('/view', '/preview') : ''}" class="w-full h-full border-none bg-white opacity-90" title="Document Preview"></iframe>
                        </div>

                        <!-- Panel Derecho: Mapeo Activo -->
                        <div class="h-full flex flex-col bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden relative">
                             <div class="px-3 py-2 bg-purple-900/10 border-b border-purple-500/20 text-[10px] text-purple-300 flex justify-between">
                                <span><i data-lucide="mouse-pointer-click" class="w-3 h-3 inline mr-1"></i> Haz clic en los encabezados para asignar significado.</span>
                                <span id="mapping-status">0 campos asignados</span>
                             </div>

                            <!-- Tabla de Resultados -->
                            <div class="flex-grow overflow-auto custom-scrollbar bg-slate-950/30">
                                <table class="min-w-full divide-y divide-slate-800">
                                    <thead class="bg-slate-900 sticky top-0 z-10">
                                        <tr>
                                            ${headers.map((h, idx) => `
                                                <th onclick="toggleColumnMapping(this, '${h}')" 
                                                    class="px-3 py-2 text-left text-[10px] font-bold uppercase tracking-widest whitespace-nowrap text-slate-500 hover:text-white hover:bg-slate-800 cursor-pointer transition-colors group relative select-none header-cell"
                                                    data-header="${h}">
                                                    <div class="flex flex-col gap-1">
                                                        <span>${h}</span>
                                                        <span class="badge-mapping text-[9px] px-1.5 py-0.5 rounded hidden"></span>
                                                    </div>
                                                </th>
                                            `).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800/30">
                                        ${tableRowsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de SelecciÃ³n de Columna (Simple Overlay) -->
                <!-- Modal de Selección de Columna (Combobox Avanzado) -->
                <div id="col-mapping-modal" class="hidden absolute top-0 left-0 w-full h-full bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
                    <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl shadow-2xl w-96 flex flex-col max-h-[80vh]">
                         <h4 class="text-sm font-bold text-slate-400 uppercase mb-4">Etiquetar: <span id="modal-col-name" class="text-white"></span></h4>
                         
                         <!-- Buscador -->
                         <div class="relative mb-3">
                            <input type="text" id="dict-search" placeholder="Buscar o crear etiqueta..." 
                                   class="w-full bg-slate-800 text-white p-3 pl-10 rounded-lg text-sm border border-slate-700 focus:border-blue-500 outline-none transition-colors"
                                   oninput="filterDictionary(this.value)" autocomplete="off">
                            <i data-lucide="search" class="absolute left-3 top-3.5 w-4 h-4 text-slate-500"></i>
                         </div>

                         <!-- Lista de Términos -->
                         <div id="dict-list" class="flex flex-col gap-1 overflow-y-auto custom-scrollbar flex-grow min-h-0 mb-4 pr-1">
                            <!-- Inyectado por JS -->
                         </div>

                         <div class="h-px bg-slate-700 mb-3 shrink-0"></div>
                         
                         <button onclick="applyMapping('ignore')" class="w-full text-left px-4 py-3 bg-slate-800 hover:bg-red-900/20 hover:text-red-400 text-slate-500 hover:line-through text-sm rounded-lg transition-colors flex items-center gap-2 mb-2 shrink-0">
                            <i data-lucide="ban" class="w-4 h-4"></i> Ignorar esta columna
                         </button>
                         <button onclick="closeMappingModal()" class="w-full py-2 text-xs text-slate-500 hover:text-white uppercase font-bold tracking-widest shrink-0">Cancelar</button>
                    </div>
                </div>
            `;
            reportDisplay.innerHTML = html;
            lucide.createIcons();
        }

        // --- Lógica de Interfaz de Mapeo (Combobox) ---
        let activeHeader = null;

        function toggleColumnMapping(element, header) {
            activeHeader = header;
            document.getElementById('modal-col-name').innerText = header;

            // Reset y Focus
            const input = document.getElementById('dict-search');
            input.value = '';
            filterDictionary(''); // Mostrar todo

            document.getElementById('col-mapping-modal').classList.remove('hidden');
            input.focus();
        }

        function filterDictionary(query) {
            const list = document.getElementById('dict-list');
            list.innerHTML = '';

            const q = query.toUpperCase();
            const matches = dictionary.filter(item => item.termino.includes(q));
            const exactMatch = matches.find(item => item.termino === q);

            // Render Matches
            if (matches.length === 0 && q.length === 0) {
                list.innerHTML = `
                    <div class="p-4 text-center text-slate-500 text-xs italic opacity-50 select-none">
                        <i data-lucide="book-open" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                        Tu diccionario está vacío.<br>Escribe para crear tu primera etiqueta.
                    </div>
                 `;
            }

            matches.forEach(item => {
                const btn = document.createElement('button');
                // Estilo condicional según sistema/custom
                const isSystem = item.categoria === 'SYSTEM';
                const colorClass = isSystem ? 'text-blue-300' : 'text-emerald-300';

                btn.className = `w-full text-left px-4 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors text-sm flex justify-between items-center group`;
                btn.innerHTML = `
                    <span class="${colorClass} font-bold">${item.termino}</span>
                    <span class="text-[10px] text-slate-500 uppercase tracking-wider group-hover:text-slate-300">${item.categoria}</span>
                `;
                btn.onclick = () => applyMapping(item.termino);
                list.appendChild(btn);
            });

            // Opción Crear Si no existe exacto y hay query
            if (!exactMatch && q.length > 0) {
                const createBtn = document.createElement('button');
                createBtn.className = `w-full text-left px-4 py-3 bg-indigo-600/20 hover:bg-indigo-600/30 border border-indigo-500/30 rounded-lg transition-colors text-sm text-indigo-300 flex items-center justify-center gap-2 mt-2`;
                createBtn.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Crear nueva etiqueta: "${q}"`;
                createBtn.onclick = () => createAndApply(q);
                list.appendChild(createBtn);
            }

            lucide.createIcons();
        }

        async function createAndApply(term) {
            const btn = event.currentTarget;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Guardando...`;

            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/api/dictionary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ termino: term, descripcion: 'Creado por usuario' })
                });
                const newItem = await res.json();

                // Actualizar cache local
                dictionary.push(newItem);
                dictionary.sort((a, b) => a.termino.localeCompare(b.termino));

                applyMapping(newItem.termino);

            } catch (e) {
                alert("Error creando término: " + e.message);
                filterDictionary(term); // Reset UI
            }
        }

        function closeMappingModal() {
            document.getElementById('col-mapping-modal').classList.add('hidden');
            activeHeader = null;
        }

        function applyMapping(type) {
            if (!activeHeader) return;

            if (type === 'ignore') {
                delete currentMapping[activeHeader]; // O marcar explicitamente
                // Visual cleanup handled below
            } else {
                // Verificar si ya existe este tipo asignado a otra columna (ej: solo 1 SKU)
                // Opcional: Permitir override
                Object.keys(currentMapping).forEach(key => {
                    if (currentMapping[key] === type) delete currentMapping[key];
                });
                currentMapping[activeHeader] = type;
            }

            updateHeaderVisuals();
            closeMappingModal();
        }

        function updateHeaderVisuals() {
            // Recorrer todos los headers y actualizar badges/colores
            const headers = document.querySelectorAll('.header-cell');
            let mappedCount = 0;

            headers.forEach(th => {
                const hName = th.getAttribute('data-header');
                const type = currentMapping[hName];
                const badge = th.querySelector('.badge-mapping');

                if (type) {
                    mappedCount++;
                    badge.classList.remove('hidden');
                    badge.innerText = type.toUpperCase();

                    // Colores por tipo (Dinámico)
                    let colorClass = 'bg-slate-700 text-white'; // Fallback

                    // Buscar en diccionario para saber categoría
                    const dictItem = dictionary.find(d => d.termino === type);
                    const isSystem = dictItem ? dictItem.categoria === 'SYSTEM' : false;

                    if (isSystem) {
                        if (type === 'SKU') colorClass = 'bg-purple-600 text-white shadow-lg shadow-purple-900/20';
                        else if (type === 'DESCRIPCION') colorClass = 'bg-blue-600 text-white shadow-lg shadow-blue-900/20';
                        else if (type === 'PRECIO') colorClass = 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20';
                        else if (type === 'STOCK') colorClass = 'bg-orange-600 text-white shadow-lg shadow-orange-900/20';
                        else colorClass = 'bg-slate-600 text-white';
                    } else {
                        // Custom Tag - Color Distintivo
                        colorClass = 'bg-indigo-500 text-white border border-indigo-400 font-bold shadow-lg shadow-indigo-900/30';
                    }

                    badge.className = `badge-mapping text-[10px] px-2 py-0.5 rounded-md mt-1 inline-block ${colorClass}`;
                    th.classList.add('text-white');
                } else {
                    badge.classList.add('hidden');
                    th.classList.remove('text-white');
                }
            });
            document.getElementById('mapping-status').innerText = `${mappedCount} campos asignados`;
            document.getElementById('mapping-status').innerText = `${mappedCount} campos asignados`;
        }

        async function refreshWithNewHeader() {
            const input = document.getElementById('headerIndexInput');
            const newIndex = parseInt(input.value);
            if (isNaN(newIndex) || newIndex < 0) return alert("Fila inválida");

            const btn = document.querySelector('button[title="Actualizar Vista"]');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>`;

            try {
                // Re-iniciamos extracción con el nuevo índice
                await startExtraction(currentFileCtx.fileId, currentFileCtx.fileName, currentFileCtx.providerId, currentFileCtx.webViewLink, newIndex);
            } catch (e) {
                alert("Error refrescando: " + e.message);
                btn.innerHTML = `<i data-lucide="refresh-cw" class="w-3 h-3"></i>`;
                lucide.createIcons();
            }
        }

        async function confirmFinalMapping() {
            // Validar mÃ­nimos
            const values = Object.values(currentMapping);
            if (!values.includes('sku') || !values.includes('precio')) {
                alert("⚠️ Debes asignar al menos SKU y PRECIO para confirmar.");
                return;
            }

            if (!confirm("Â¿Confirmar esta estructura? El sistema aprenderÃ¡ este formato para futuros archivos.")) return;

            const btn = document.querySelector('button[onclick="confirmFinalMapping()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Guardando...`;
            btn.disabled = true;

            try {
                // Invertir mapeo para el backend: { "SKU": "Col A", ... }
                // currentMapping es { "Col A": "sku" }
                // Backend espera: { "sku": "Col A", "precio": "Col B" }
                const backendMapping = {};
                Object.entries(currentMapping).forEach(([col, type]) => {
                    backendMapping[type] = col;
                });

                const res = await fetch(`${CONFIG.BACKEND_URL}/api/files/extraction/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileId: currentFileCtx.fileId,
                        providerId: currentFileCtx.providerId,
                        mapping: backendMapping,
                        headers: currentHeaders,
                        headerIndex: currentHeaderIndex // [EXCAVACION] Persistimos el offset
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                alert("✅ Â¡Inteligencia Guardada! El archivo ha sido procesado con Ã©xito.");
                loadProveedores(); // Volver al inicio

            } catch (error) {
                console.error(error);
                alert("Error guardando mapeo: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>