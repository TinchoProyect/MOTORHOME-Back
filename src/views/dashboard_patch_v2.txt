        // Variables Globales de Mapeo
        let currentMapping = {};
        let currentHeaders = [];
        let currentFileCtx = {};

        async function startExtraction(fileId, fileName, providerId, webViewLink) {
             const reportDisplay = document.getElementById('reportDisplay');
             reportDisplay.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-slate-400 gap-4 animate-pulse">
                    <i data-lucide="brain-circuit" class="w-12 h-12 text-blue-500"></i>
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-white">Analizando Estructura...</h3>
                        <p class="text-sm">El motor de IA est√° leyendo el archivo directo.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();

            try {
                // LLAMADA AL BACKEND
                const res = await fetch('/api/files/extraction/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileId, fileName, providerId })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || "Error en el proceso de extracci√≥n");
                }

                // 3. Renderizar Resultados (Active Mapping Mode)
                renderExtractionResults(data, fileName, webViewLink, fileId, providerId);

            } catch (error) {
                console.error("Extraction Error:", error);
                reportDisplay.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-red-400 gap-2 p-8 text-center">
                        <i data-lucide="alert-triangle" class="w-10 h-10"></i>
                        <h3 class="text-lg font-bold">Error en Extracci√≥n</h3>
                        <p class="text-xs bg-slate-900/50 p-2 rounded border border-red-500/20 font-mono">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderExtractionResults(result, fileName, webViewLink, fileId, providerId) {
            // Guardar Contexto Global
            currentFileCtx = { fileId, providerId, fileName };
            currentHeaders = result.data.headers_detected || [];
            currentMapping = {}; // Reset de mapeo

            const isDiscovery = result.mode === 'DISCOVERY';
            const headers = currentHeaders;
            const rows = result.data.data_sample || [];
            
            // Generar Filas de Tabla
            let tableRowsHtml = '';
            rows.forEach(row => {
                tableRowsHtml += `<tr class="border-b border-slate-800/50 hover:bg-slate-800/20 transition-colors">`;
                headers.forEach(h => {
                    const cellVal = row[h] || '-';
                    tableRowsHtml += `<td class="px-3 py-2 text-xs text-slate-300 whitespace-nowrap">${cellVal}</td>`;
                });
                tableRowsHtml += '</tr>';
            });
            
            // Crear HTML Base
            let html = `
                <div class="h-full flex flex-col p-4 animate-in slide-in-from-right duration-500 overflow-hidden">
                    <!-- Header Reporte -->
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800 shrink-0">
                        <div>
                            <div class="flex items-center gap-3 mb-1">
                                <h2 class="text-xl font-bold text-white">Informe de Conocimiento</h2>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${isDiscovery ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30'} uppercase">
                                    ${isDiscovery ? 'MODO ARQUE√ìLOGO' : 'MODO OPERARIO'}
                                </span>
                            </div>
                            <p class="text-xs text-slate-500 font-mono">Archivo: ${fileName}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="confirmFinalMapping()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-widest rounded-lg shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Confirmar Inteligencia
                            </button>
                             <button onclick="loadProveedores()" class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded-lg transition-colors">
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Layout Side-by-Side -->
                    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-4 overflow-hidden h-full pb-4">
                        
                        <!-- Panel Izquierdo: Documento -->
                        <div class="h-full bg-slate-900 rounded-xl border border-slate-800 overflow-hidden flex flex-col">
                            <div class="bg-slate-950 px-3 py-2 border-b border-slate-800 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2"><i data-lucide="eye" class="w-3 h-3"></i> Documento Original</span>
                                <a href="${webViewLink}" target="_blank" class="text-[10px] text-blue-400 hover:underline">Abrir en Pesta√±a</a>
                            </div>
                            <iframe src="${webViewLink ? webViewLink.replace('/view', '/preview') : ''}" class="w-full h-full border-none bg-white opacity-90" title="Document Preview"></iframe>
                        </div>

                        <!-- Panel Derecho: Mapeo Activo -->
                        <div class="h-full flex flex-col bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden relative">
                             <div class="px-3 py-2 bg-purple-900/10 border-b border-purple-500/20 text-[10px] text-purple-300 flex justify-between">
                                <span><i data-lucide="mouse-pointer-click" class="w-3 h-3 inline mr-1"></i> Haz clic en los encabezados para asignar significado.</span>
                                <span id="mapping-status">0 campos asignados</span>
                             </div>

                            <!-- Tabla de Resultados -->
                            <div class="flex-grow overflow-auto custom-scrollbar bg-slate-950/30">
                                <table class="min-w-full divide-y divide-slate-800">
                                    <thead class="bg-slate-900 sticky top-0 z-10">
                                        <tr>
                                            ${headers.map((h, idx) => `
                                                <th onclick="toggleColumnMapping(this, '${h}')" 
                                                    class="px-3 py-2 text-left text-[10px] font-bold uppercase tracking-widest whitespace-nowrap text-slate-500 hover:text-white hover:bg-slate-800 cursor-pointer transition-colors group relative select-none header-cell"
                                                    data-header="${h}">
                                                    <div class="flex flex-col gap-1">
                                                        <span>${h}</span>
                                                        <span class="badge-mapping text-[9px] px-1.5 py-0.5 rounded hidden"></span>
                                                    </div>
                                                </th>
                                            `).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800/30">
                                        ${tableRowsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de Selecci√≥n de Columna (Simple Overlay) -->
                <div id="col-mapping-modal" class="hidden absolute top-0 left-0 w-full h-full bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center fade-in">
                    <div class="bg-slate-900 border border-slate-700 p-4 rounded-xl shadow-2xl w-64">
                         <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Asignar Columna: <span id="modal-col-name" class="text-white"></span></h4>
                         <div class="flex flex-col gap-2">
                            <button onclick="applyMapping('sku')" class="text-left px-3 py-2 bg-slate-800 hover:bg-purple-600/20 hover:text-purple-400 text-slate-300 text-xs rounded transition-colors border border-transparent hover:border-purple-500/30">üì¶ SKU / C√≥digo</button>
                            <button onclick="applyMapping('descripcion')" class="text-left px-3 py-2 bg-slate-800 hover:bg-blue-600/20 hover:text-blue-400 text-slate-300 text-xs rounded transition-colors border border-transparent hover:border-blue-500/30">üìù Descripci√≥n</button>
                            <button onclick="applyMapping('precio')" class="text-left px-3 py-2 bg-slate-800 hover:bg-emerald-600/20 hover:text-emerald-400 text-slate-300 text-xs rounded transition-colors border border-transparent hover:border-emerald-500/30">üí≤ Precio</button>
                            <button onclick="applyMapping('stock')" class="text-left px-3 py-2 bg-slate-800 hover:bg-orange-600/20 hover:text-orange-400 text-slate-300 text-xs rounded transition-colors border border-transparent hover:border-orange-500/30">üìä Stock</button>
                            <div class="h-px bg-slate-700 my-1"></div>
                            <button onclick="applyMapping('ignore')" class="text-left px-3 py-2 bg-slate-800 hover:bg-red-900/20 hover:text-red-400 text-slate-500 hover:line-through text-xs rounded transition-colors">üö´ Ignorar Columna</button>
                         </div>
                         <button onclick="closeMappingModal()" class="mt-3 w-full py-1.5 text-[10px] text-slate-500 hover:text-white uppercase">Cancelar</button>
                    </div>
                </div>
            `;
            reportDisplay.innerHTML = html;
            lucide.createIcons();
        }

        // --- L√≥gica de Interfaz de Mapeo ---
        let activeHeader = null;

        function toggleColumnMapping(element, header) {
            activeHeader = header;
            document.getElementById('modal-col-name').innerText = header;
            document.getElementById('col-mapping-modal').classList.remove('hidden');
        }

        function closeMappingModal() {
             document.getElementById('col-mapping-modal').classList.add('hidden');
             activeHeader = null;
        }

        function applyMapping(type) {
            if (!activeHeader) return;

            if (type === 'ignore') {
                delete currentMapping[activeHeader]; // O marcar explicitamente
                // Visual cleanup handled below
            } else {
                // Verificar si ya existe este tipo asignado a otra columna (ej: solo 1 SKU)
                // Opcional: Permitir override
                 Object.keys(currentMapping).forEach(key => {
                    if (currentMapping[key] === type) delete currentMapping[key];
                 });
                currentMapping[activeHeader] = type;
            }
            
            updateHeaderVisuals();
            closeMappingModal();
        }

        function updateHeaderVisuals() {
            // Recorrer todos los headers y actualizar badges/colores
            const headers = document.querySelectorAll('.header-cell');
            let mappedCount = 0;

            headers.forEach(th => {
                const hName = th.getAttribute('data-header');
                const type = currentMapping[hName];
                const badge = th.querySelector('.badge-mapping');
                
                if (type) {
                    mappedCount++;
                    badge.classList.remove('hidden');
                    badge.innerText = type.toUpperCase();
                    
                    // Colores por tipo
                    let colorClass = 'bg-slate-700 text-white';
                    if (type === 'sku') colorClass = 'bg-purple-600 text-white';
                    if (type === 'descripcion') colorClass = 'bg-blue-600 text-white';
                    if (type === 'precio') colorClass = 'bg-emerald-600 text-white';
                    
                    badge.className = `badge-mapping text-[9px] px-1.5 py-0.5 rounded mt-1 inline-block ${colorClass}`;
                    th.classList.add('text-white');
                } else {
                    badge.classList.add('hidden');
                    th.classList.remove('text-white');
                }
            });
            document.getElementById('mapping-status').innerText = `${mappedCount} campos asignados`;
        }

        async function confirmFinalMapping() {
            // Validar m√≠nimos
            const values = Object.values(currentMapping);
            if (!values.includes('sku') || !values.includes('precio')) {
                alert("‚ö†Ô∏è Debes asignar al menos SKU y PRECIO para confirmar.");
                return;
            }

            if (!confirm("¬øConfirmar esta estructura? El sistema aprender√° este formato para futuros archivos.")) return;

            const btn = document.querySelector('button[onclick="confirmFinalMapping()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Guardando...`;
            btn.disabled = true;

            try {
                // Invertir mapeo para el backend: { "SKU": "Col A", ... }
                // currentMapping es { "Col A": "sku" }
                // Backend espera: { "sku": "Col A", "precio": "Col B" }
                const backendMapping = {};
                Object.entries(currentMapping).forEach(([col, type]) => {
                    backendMapping[type] = col;
                });

                const res = await fetch('/api/files/extraction/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileId: currentFileCtx.fileId,
                        providerId: currentFileCtx.providerId,
                        mapping: backendMapping,
                        headers: currentHeaders
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                alert("‚úÖ ¬°Inteligencia Guardada! El archivo ha sido procesado con √©xito.");
                loadProveedores(); // Volver al inicio

            } catch (error) {
                console.error(error);
                alert("Error guardando mapeo: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
